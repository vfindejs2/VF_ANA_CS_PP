<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konceptualni model — RoadPlan (RP) — Cyklicke svozy CS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #1a1a2e;
            padding: 32px;
        }
        h1 { font-size: 1.5rem; margin-bottom: 4px; }
        .subtitle { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .diagram-container {
            background: white;
            border-radius: 10px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: auto;
        }
        .note {
            margin-top: 16px;
            padding: 12px 16px;
            background: #f0f0f0;
            border-left: 4px solid #888;
            border-radius: 4px;
            font-size: 0.84rem;
            line-height: 1.5;
        }
        .note + .note { margin-top: 8px; }
        .note.warn {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }
    </style>
</head>
<body>
    <h1>Konceptualni model: RoadPlan (RP)</h1>
    <p class="subtitle">Cyklicke svozy MP SK | Business pohled — entity a jejich vazby bez atributu</p>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div><span>Stavajici entita (beze zmen)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div><span>Stavajici entita (upravena pro CS)</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #22c55e;"></div><span>Nova entita — Etapa 1</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #a855f7;"></div><span>Nova entita — Etapa 2</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #06b6d4;"></div><span>Sync z PP</span></div>
    </div>

    <div class="diagram-container">
        <div id="diagram"></div>
    </div>

    <div class="note">
        <strong>Jak cist diagram:</strong> Plne sedy cary = stavajici vazby. Zelene carkove = nove vazby Etapa 1.
        Fialove carkove = nove vazby Etapa 2. Cyanove teckovane = sync z PasPortu.
        Cisla u vztahu (B1, B3 atd.) odkazuji na pozadavky z Ciloveho konceptu.
    </div>
    <div class="note warn">
        <strong>Architektonicke rozhodnuti (B3):</strong> Objednana sluzba je zobrazena jako rozsireni stavajici entity.
        Alternativne muze vzniknout nova separatni entita <em>CS Objednana sluzba</em>.
    </div>

    <script>
    const SVG_NS = 'http://www.w3.org/2000/svg';

    const entities = [
        // === Existing unchanged ===
        { id: 'org_unit',      label: 'Provozovna',                 x: 530, y: 40,   color: '#3b82f6', type: 'existing' },
        { id: 'liq_site',      label: 'Likvidacni\nmisto',          x: 110, y: 40,   color: '#3b82f6', type: 'existing' },
        { id: 'ls_garbage',    label: 'Druh odpadu\nlik. mista',    x: 110, y: 150,  color: '#3b82f6', type: 'existing' },
        { id: 'os_status',     label: 'Stav OS',                    x: 730, y: 280,  color: '#3b82f6', type: 'existing' },
        { id: 'exec_site',     label: 'Misto\nrealizace',           x: 730, y: 400,  color: '#3b82f6', type: 'existing' },
        { id: 'settings',      label: 'Nastaveni',                  x: 730, y: 40,   color: '#3b82f6', type: 'existing' },

        // === Existing modified ===
        { id: 'day_perf',      label: 'Denni vykon',                x: 110, y: 280,  color: '#f59e0b', type: 'modified' },
        { id: 'dpi',           label: 'Polozka\ndenniho vykonu',    x: 110, y: 400,  color: '#f59e0b', type: 'modified' },
        { id: 'dpi_type',      label: 'Typ polozky DV',             x: 110, y: 510,  color: '#f59e0b', type: 'modified' },
        { id: 'os',            label: 'Objednana\nsluzba (OS)',     x: 530, y: 280,  color: '#f59e0b', type: 'modified', w: 160 },
        { id: 'os_loc',        label: 'Lokace OS',                  x: 530, y: 400,  color: '#f59e0b', type: 'modified' },
        { id: 'vehicle',       label: 'Vozidlo',                    x: 310, y: 40,   color: '#f59e0b', type: 'modified' },
        { id: 'transport_type',label: 'Typ dopravy',                x: 110, y: 150,  color: '#f59e0b', type: 'modified', x: 310, y: 150 },
        { id: 'garbage_type',  label: 'Druh odpadu',                x: 730, y: 150,  color: '#f59e0b', type: 'modified' },
        { id: 'container_type',label: 'Typ nadoby',                 x: 530, y: 510,  color: '#f59e0b', type: 'modified' },

        // === Sync from PP ===
        { id: 'circuit',       label: 'Okruh\n(sync z PP)',         x: 310, y: 510,  color: '#06b6d4', type: 'sync' },
        { id: 'schedule',      label: 'Rozvrh\n(sync z PP)',        x: 730, y: 510,  color: '#06b6d4', type: 'sync' },
        { id: 'schedule_day',  label: 'Kalendarni den\nrozvrhu',    x: 900, y: 510,  color: '#06b6d4', type: 'sync', w: 140 },
        { id: 'garbage_group', label: 'Skupina odpadu\n(sync z PP)',x: 530, y: 150,  color: '#06b6d4', type: 'sync', w: 160 },

        // === New Etapa 1 ===
        { id: 'day_circuit',   label: 'Okruh dne',                  x: 310, y: 280,  color: '#22c55e', type: 'new' },
        { id: 'dc_liq_site',   label: 'LM okruhu dne',             x: 110, y: 150,  color: '#22c55e', type: 'new', x: 40, y: 150 },
        { id: 'cs_gen_config', label: 'Konfigurace\ngenerovani CS', x: 900, y: 40,   color: '#22c55e', type: 'new', w: 155 },

        // === New Etapa 2 ===
        { id: 'dc_weight',     label: 'Zaznam vahy\nokruhu dne',    x: 310, y: 400,  color: '#a855f7', type: 'new2' },
        { id: 'sp_version',    label: 'Verze strat.\nplanovani',    x: 900, y: 280,  color: '#a855f7', type: 'new2' },
        { id: 'sp_config',     label: 'Konfigurace SP',             x: 900, y: 400,  color: '#a855f7', type: 'new2' },
    ];

    // Fix duplicate x/y for transport_type
    entities.find(e => e.id === 'transport_type').x = 310;
    entities.find(e => e.id === 'transport_type').y = 150;
    entities.find(e => e.id === 'dc_liq_site').x = 40;
    entities.find(e => e.id === 'dc_liq_site').y = 150;
    entities.find(e => e.id === 'ls_garbage').x = 40;
    entities.find(e => e.id === 'ls_garbage').y = 40;

    const relationships = [
        // Existing (solid gray)
        { from: 'day_perf',    to: 'vehicle',         label: 'N:1',          style: 'solid' },
        { from: 'day_perf',    to: 'transport_type',   label: 'N:1',          style: 'solid' },
        { from: 'day_perf',    to: 'org_unit',         label: 'N:1',          style: 'solid' },
        { from: 'dpi',         to: 'day_perf',         label: 'N:1',          style: 'solid' },
        { from: 'dpi',         to: 'dpi_type',         label: 'N:1',          style: 'solid' },
        { from: 'dpi',         to: 'os',               label: 'N:1',          style: 'solid', path: [{x: 180, y: 430}, {x: 480, y: 430}, {x: 480, y: 310}] },
        { from: 'os',          to: 'os_status',        label: 'N:1',          style: 'solid' },
        { from: 'os_loc',      to: 'os',               label: 'N:1',          style: 'solid' },
        { from: 'os_loc',      to: 'exec_site',        label: 'N:1',          style: 'solid' },
        { from: 'os_loc',      to: 'liq_site',         label: 'N:1',          style: 'solid', path: [{x: 560, y: 450}, {x: 560, y: 600}, {x: 30, y: 600}, {x: 30, y: 88}] },
        { from: 'ls_garbage',  to: 'liq_site',         label: 'N:1',          style: 'solid' },
        { from: 'liq_site',    to: 'org_unit',         label: 'N:1',          style: 'solid' },

        // New Etapa 1 — Okruh dne (dashed green)
        { from: 'day_circuit', to: 'circuit',          label: 'N:1\n(B1)',    style: 'dashed' },
        { from: 'day_circuit', to: 'garbage_group',    label: 'N:1\n(B1)',    style: 'dashed' },
        { from: 'day_circuit', to: 'vehicle',          label: 'N:1\n(B1)',    style: 'dashed', path: [{x: 360, y: 258}, {x: 360, y: 88}] },
        { from: 'day_circuit', to: 'day_perf',         label: 'N:1\n(B1)',    style: 'dashed' },
        { from: 'day_circuit', to: 'org_unit',         label: 'N:1',          style: 'dashed', path: [{x: 385, y: 258}, {x: 385, y: 220}, {x: 530, y: 68}] },
        { from: 'dc_liq_site', to: 'day_circuit',      label: 'N:1\n(B1)',    style: 'dashed', path: [{x: 115, y: 198}, {x: 115, y: 240}, {x: 310, y: 280}] },
        { from: 'dc_liq_site', to: 'liq_site',         label: 'N:1',          style: 'dashed', path: [{x: 90, y: 128}, {x: 135, y: 88}] },
        { from: 'dpi',         to: 'day_circuit',      label: 'N:1\n(B1)',    style: 'dashed', path: [{x: 185, y: 428}, {x: 260, y: 428}, {x: 260, y: 330}, {x: 310, y: 310}] },

        // OS extensions (dashed green)
        { from: 'os',          to: 'day_circuit',      label: 'N:1\n(B3)',    style: 'dashed' },
        { from: 'os',          to: 'circuit',          label: 'N:1\n(B3)',    style: 'dashed', path: [{x: 505, y: 310}, {x: 420, y: 510}] },
        { from: 'os',          to: 'schedule',         label: 'N:1\n(B3)',    style: 'dashed', path: [{x: 715, y: 310}, {x: 760, y: 488}] },
        { from: 'os',          to: 'garbage_group',    label: 'N:1\n(B3)',    style: 'dashed', path: [{x: 610, y: 258}] },
        { from: 'os',          to: 'garbage_type',     label: 'N:1\n(B3)',    style: 'dashed', path: [{x: 690, y: 258}, {x: 780, y: 198}] },
        { from: 'os',          to: 'container_type',   label: 'N:1\n(B3)',    style: 'dashed', path: [{x: 590, y: 340}, {x: 590, y: 488}] },

        // OS Location extensions
        { from: 'os_loc',      to: 'garbage_group',    label: 'N:1\n(B4)',    style: 'dashed', path: [{x: 630, y: 398}, {x: 630, y: 198}] },
        { from: 'os_loc',      to: 'container_type',   label: 'N:1\n(B4)',    style: 'dashed' },

        // Sync entities internal
        { from: 'schedule',    to: 'schedule_day',     label: '1:N',          style: 'cyan' },
        { from: 'garbage_type',to: 'garbage_group',    label: 'N:1\n(B9)',    style: 'dashed' },

        // Config
        { from: 'cs_gen_config',to: 'org_unit',        label: 'N:1\n(B7)',    style: 'dashed', path: [{x: 955, y: 88}] },

        // Etapa 2 (dashed purple)
        { from: 'dc_weight',   to: 'day_circuit',      label: 'N:1\n(B12)',   style: 'purple' },
        { from: 'sp_config',   to: 'sp_version',       label: 'N:1\n(B8)',    style: 'purple' },
        { from: 'sp_version',  to: 'org_unit',         label: 'N:1\n(B8)',    style: 'purple', path: [{x: 975, y: 258}, {x: 975, y: 180}, {x: 680, y: 68}] },
    ];

    // --- Render ---
    const W = 1100, H = 650;
    const svg = document.createElementNS(SVG_NS, 'svg');
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', H);
    svg.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";

    const defs = document.createElementNS(SVG_NS, 'defs');
    defs.innerHTML = `
        <marker id="arrow" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
            <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
        </marker>
        <marker id="arrow-green" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
            <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
        </marker>
        <marker id="arrow-cyan" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
            <polygon points="0 0, 10 3.5, 0 7" fill="#06b6d4"/>
        </marker>
        <marker id="arrow-purple" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
            <polygon points="0 0, 10 3.5, 0 7" fill="#a855f7"/>
        </marker>
    `;
    svg.appendChild(defs);

    const ENTITY_W = 150, ENTITY_H = 50;

    function entityCenter(e) {
        const w = e.w || ENTITY_W;
        return { x: e.x + w/2, y: e.y + ENTITY_H/2 };
    }

    function entityEdgePoint(e, target) {
        const c = entityCenter(e);
        const w = (e.w || ENTITY_W)/2, h = ENTITY_H/2;
        const dx = target.x - c.x, dy = target.y - c.y;
        if (dx === 0 && dy === 0) return c;
        const absDx = Math.abs(dx), absDy = Math.abs(dy);
        let scale;
        if (absDx * h > absDy * w) { scale = w / absDx; }
        else { scale = h / absDy; }
        return { x: c.x + dx * scale, y: c.y + dy * scale };
    }

    function getColor(style) {
        if (style === 'dashed') return '#22c55e';
        if (style === 'cyan') return '#06b6d4';
        if (style === 'purple') return '#a855f7';
        if (style === 'dotted') return '#ef4444';
        return '#94a3b8';
    }
    function getMarker(style) {
        if (style === 'dashed') return 'arrow-green';
        if (style === 'cyan') return 'arrow-cyan';
        if (style === 'purple') return 'arrow-purple';
        return 'arrow';
    }

    // Draw relationships
    relationships.forEach(r => {
        const eFrom = entities.find(e => e.id === r.from);
        const eTo = entities.find(e => e.id === r.to);
        if (!eFrom || !eTo) return;

        const cFrom = entityCenter(eFrom);
        const cTo = entityCenter(eTo);
        let points = r.path ? [cFrom, ...r.path, cTo] : [cFrom, cTo];
        points[0] = entityEdgePoint(eFrom, points[1]);
        points[points.length - 1] = entityEdgePoint(eTo, points[points.length - 2]);

        const line = document.createElementNS(SVG_NS, 'polyline');
        line.setAttribute('points', points.map(p => `${p.x},${p.y}`).join(' '));
        line.setAttribute('fill', 'none');
        const color = getColor(r.style);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', r.style === 'solid' ? '1.5' : '2');
        if (r.style === 'dashed' || r.style === 'purple') line.setAttribute('stroke-dasharray', '8,4');
        if (r.style === 'cyan') line.setAttribute('stroke-dasharray', '4,2');
        line.setAttribute('marker-end', `url(#${getMarker(r.style)})`);
        svg.appendChild(line);

        const midIdx = Math.floor(points.length / 2);
        const mp = {
            x: (points[midIdx-1].x + points[midIdx].x) / 2,
            y: (points[midIdx-1].y + points[midIdx].y) / 2
        };
        const labelLines = r.label.split('\n');
        labelLines.forEach((txt, i) => {
            const t = document.createElementNS(SVG_NS, 'text');
            t.setAttribute('x', mp.x);
            t.setAttribute('y', mp.y - 4 + i * 12 - (labelLines.length-1)*5);
            t.setAttribute('text-anchor', 'middle');
            t.setAttribute('font-size', '9');
            t.setAttribute('fill', color);
            t.setAttribute('font-weight', i === 0 ? '600' : '400');
            t.textContent = txt;
            svg.appendChild(t);
            const bbox = t.getBBox();
            const bg = document.createElementNS(SVG_NS, 'rect');
            bg.setAttribute('x', bbox.x - 2);
            bg.setAttribute('y', bbox.y - 1);
            bg.setAttribute('width', bbox.width + 4);
            bg.setAttribute('height', bbox.height + 2);
            bg.setAttribute('fill', 'white');
            bg.setAttribute('opacity', '0.85');
            bg.setAttribute('rx', '2');
            svg.insertBefore(bg, t);
        });
    });

    // Draw entities
    entities.forEach(e => {
        const w = e.w || ENTITY_W;
        const isNew = e.type === 'new' || e.type === 'new2' || e.type === 'sync';
        const g = document.createElementNS(SVG_NS, 'g');

        const shadow = document.createElementNS(SVG_NS, 'rect');
        shadow.setAttribute('x', e.x + 2);
        shadow.setAttribute('y', e.y + 2);
        shadow.setAttribute('width', w);
        shadow.setAttribute('height', ENTITY_H);
        shadow.setAttribute('rx', '8');
        shadow.setAttribute('fill', 'rgba(0,0,0,0.06)');
        g.appendChild(shadow);

        const rect = document.createElementNS(SVG_NS, 'rect');
        rect.setAttribute('x', e.x);
        rect.setAttribute('y', e.y);
        rect.setAttribute('width', w);
        rect.setAttribute('height', ENTITY_H);
        rect.setAttribute('rx', '8');
        rect.setAttribute('fill', 'white');
        rect.setAttribute('stroke', e.color);
        rect.setAttribute('stroke-width', isNew ? '2.5' : '1.5');
        g.appendChild(rect);

        const bar = document.createElementNS(SVG_NS, 'rect');
        bar.setAttribute('x', e.x);
        bar.setAttribute('y', e.y);
        bar.setAttribute('width', w);
        bar.setAttribute('height', '5');
        bar.setAttribute('fill', e.color);
        const clip = document.createElementNS(SVG_NS, 'clipPath');
        clip.id = `clip-${e.id}`;
        const clipRect = document.createElementNS(SVG_NS, 'rect');
        clipRect.setAttribute('x', e.x);
        clipRect.setAttribute('y', e.y);
        clipRect.setAttribute('width', w);
        clipRect.setAttribute('height', ENTITY_H);
        clipRect.setAttribute('rx', '8');
        clip.appendChild(clipRect);
        defs.appendChild(clip);
        bar.setAttribute('clip-path', `url(#clip-${e.id})`);
        g.appendChild(bar);

        const lines = e.label.split('\n');
        const lineHeight = 13;
        const totalH = lines.length * lineHeight;
        const startY = e.y + ENTITY_H/2 - totalH/2 + lineHeight - 1;
        lines.forEach((line, i) => {
            const t = document.createElementNS(SVG_NS, 'text');
            t.setAttribute('x', e.x + w/2);
            t.setAttribute('y', startY + i * lineHeight);
            t.setAttribute('text-anchor', 'middle');
            t.setAttribute('font-size', '11.5');
            t.setAttribute('font-weight', '600');
            t.setAttribute('fill', '#1a1a2e');
            t.textContent = line;
            g.appendChild(t);
        });

        svg.appendChild(g);
    });

    document.getElementById('diagram').appendChild(svg);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>FlwUC01: Synchronizovat události výsypu nádob</title>
</head>
<body>
<div class="wiki-content">
<p></p><h1>Stručný popis, cíl</h1><p>Cílem případu užití je zajištění synchronizace událostí výsypu nádoby ze systému FLWW2. Akce pak probíhá v předepsaném intervalu, a to přímým dotazováním odpovídajícího API.</p><p>Poznámka: Jedná se o kontrolní synchronizaci, která probíhá v nočních hodinách jako doplněk <a href="https://confluence.radium.cz/display/FLWWPAS/FlwUC02%3A+Synchronizovat+objekt">FlwUC02: Synchronizovat objekt</a>.</p><p>Interní poznámka: V případě implementace komunikace pomocí RabbitMQ bude UC sloužit ke kontrolním „půlnočním“ synchronizacím.</p><h1>Seznam aktérů</h1><table><tbody><tr><th>Aktér</th><th colspan="1">Poznámka</th></tr><tr><td colspan="1">Čas</td><td colspan="1">Zajišťuje spuštění případu užití.</td></tr><tr><td colspan="1">Systém FLWW2</td><td colspan="1">Zajišťuje dodání informací o synchronizovaném záznamu.</td></tr></tbody></table><p>Poznámka: Úplný přehled aktérů je zobrazen samostatně, viz <a href="#" data-page-title="Přehled aktérů"></a>.</p><h1>Spuštění případů užití</h1><p>Nastane okamžik, ve kterém má dojít k synchronizaci objektů (emptyingContainerSyncPeriod, viz <a href="../../konfiguracni-hodnoty/konfiguracni-88033346.html">Konfigurační parametry</a>).</p><h2>Vstupní podmínky</h2><p>Synchronizace objektů je povolena:</p><ul><li>Hodnota konfiguračního parametru emptyingContainerSyncEnabled je rovna TRUE (viz <a href="../../konfiguracni-hodnoty/konfiguracni-88033346.html">Konfigurační parametry</a>).</li></ul><p>Je nastavena konfigurace pro synchronizaci objektů:</p><ul><li>Perioda spouštění synchronizace: emptyingContainerSyncPeriod (viz <a href="../../konfiguracni-hodnoty/konfiguracni-88033346.html">Konfigurační parametry</a>).</li><li>Počet opakování volání požadavku: emptyingContainerRetryCount (viz <a href="../../konfiguracni-hodnoty/konfiguracni-88033346.html">Konfigurační parametry</a>).</li><li>Napojení systému FLWW2 (API).</li></ul><h2>Vstupní data</h2><ul><li>Synchronizace probíhá v kontextu dahého <a href="../../datove-modely/datovy-88033012.html">Tenanta</a>.</li><li>Čas začátku spuštění posledního běhu synchronizace TlastSyncStart.</li><li>Čas konce spuštění posledního běhu synchronizace TlastSyncEnd.</li><li>Synchronizační perioda - hodnota konfiguračního parametru emptyContainerSyncPeriod.</li><li>Seznam aktivních čekajících požadavků. Aktivní požadavek má zbývající počet opakování > 0.</li></ul><h1>Základní tok událostí</h1><p>Při úplně prvním spuštění synchronizace, kdy TlastSyncStart = null, proběhne <a href="flwuc01-98239120.html">AF01: Inicializace prvního spuštění</a>.</p><ol><li>Systém zkontroluje, zda poslední synchronizace dosud neběží:<br><ul><li>Pokud hodnota TlastSyncEnd = null, pak tok událostí končí. K dalšímu pokusu o synchronizaci dojde až v následující periodě.</li><li>Jinak pokračovat na další krok.</li></ul></li><li>Systém zahájí synchronizaci:<br><ul><li>Nastaví počátek synchronizovaného období Tfrom = TlastSyncStart (odpovídá okamžiku zahájení minulé synchronizace).</li><li>Nastaví konec synchronizovaného období Tto = aktuální okamžik.</li><li>Aktualizuje čas zahájení synchronizace TlastSyncStart = aktuální okamžik.</li><li>Aktualizuje čas ukončení synchronizace TlastSyncEnd = null.</li></ul></li><li>Systém synchronuje nová data o výsypech za přírůstek času od posledního spuštění synchronizace:<br><ol><li>Zavolá externí systém Fleetware dle <a href="flwuc01-98239120.html">ALG01: Parametry volání API</a>, na vstupu předá:<br><ul><li>Čas od =  Tfrom.</li><li>Čas do = Tto.</li></ul></li><li>V závislosti na návratovém kódu odpovědi:<br><ul><li>Úspěch: Pokud je odpověď neprázdná, je spuštěn případ užití <a href="#" data-page-title="200UC30: Synchronizovat událost výsypu nádoby">200UC30: Synchronizovat událost výsypu nádoby</a> a na vstupu jsou mu předána získaná data:<ul><li>Pro jednotlivé záznamy probíhá <a href="flwuc01-98239120.html">Validace záznamů o výsypech</a> (<a href="flwuc01-98239120.html">EF03: Nevalidní záznam </a>).</li><li>Na vstup navazujícího UC jsou záznamy mapovány dle <a href="flwuc01-98239120.html">ALG04: Mapování atributů</a>.</li></ul></li><li>Chyba: Pokračovat na <a href="flwuc01-98239120.html">EF01: Chyba čtení dat z API</a></li></ul></li></ol></li><li>A dále zopakuje případná dřívější neúspěšná volání. Pro všechny záznamy ze seznamu aktivních čekajících požadavků:<br><ol><li>Je zavolán externí systém Fleetware dle <a href="flwuc01-98239120.html">ALG01: Parametry volání API</a>, na vstupu předáno:<br><ul><li>Čas od = hodnota z příslušného čekajícího požadavku.</li><li>Čas do = hodnota z příslušného čekajícího požadavku.</li></ul></li><li>V závislosti na odpovědi:<br><ul><li>Úspěch:<br><ul><li>Odpovídající čekající požadavek je odstraněn ze seznamu.</li><li>Pokud je odpověď neprázdná, je spuštěn případ užití <a href="#" data-page-title="200UC30: Synchronizovat událost výsypu nádoby">200UC30: Synchronizovat událost výsypu nádoby</a> a na vstupu jsou mu předána získaná data.</li></ul></li><li>Chyba: Pokračovat na <a href="flwuc01-98239120.html">EF02: Opakovaná chyba čtení dat z API</a></li></ul></li></ol></li><li>Systém nastaví čas ukončení synchronizace TlastSyncEnd = aktuální okamžik.</li></ol><p>Poznámka: Případné záznamy v seznamu čekajících požadavků, které mají nulový počet zbývajících požadavků, budou v této fázi projektu řešeny administrátorským zásahem. K těmto účelům bude vhodné vystavit servisní API endpoint, který umožní dodatečně zpracovat zbylé požadavky ze seznamu.</p><h1>Alternativní toky události</h1><h3>AF01: Inicializace prvního spuštění</h3><ol><li>Pokud dosud není nastavena hodnota parametru TlastSyncStart:<br><ol><li>Pak je nastavena hodnota TlastSyncStart = aktuální okamžik - emptyContainerSyncPeriod.</li><li>Hodnota TlastSyncEnd = TlastSyncStart.</li></ol></li><li>Seznam čekajících požadavků je prázdný.</li></ol><h1>Výjimkové toky událostí</h1><h3>EF01: Chyba čtení dat z API</h3><ol><li>Je založen čekající požadavek dle ALG02.</li></ol><h3>EF02: Opakovaná chyba čtení dat z API</h3><ol><li>Je aktualizován čekající požadavek dle ALG03.</li></ol><h3>EF03: Nevalidní záznam </h3><ol><li>Výskyt nevalidního záznamu je zalogován.</li><li>Pokračovat zpracováním dalšího záznamu.</li></ol><h1>Ukončení případu užití</h1><p>–</p><h2>Výstupní podmínky</h2><p>Byl zavolán navazující případ užití <a href="#" data-page-title="200UC30: Synchronizovat událost výsypu nádoby">200UC30: Synchronizovat událost výsypu nádoby</a> a případně založeny či aktualizovány čekající požadavky.</p><h2>Výstupní data</h2><p>Byla uložena data začátku a konce spuštění běhu synchronizace.</p><h1>Algoritmy</h1><h2>ALG01: Parametry volání API</h2><p>Ve space FLWW2 je API popsáno zde: <a href="#" data-page-title="API poskytující výsypy (Pasport nádob)">API poskytující výsypy (Pasport nádob)</a>.</p><p>Na vstupu jsou povinně zadány parametry: </p><ul><li>Čas od (čas uložení události do DB).</li><li>Čas do (čas uložení události do DB).</li></ul><p>Na výstupu jsou vráceny parametry:</p><ul><li>Id události (id),</li><li>Datum a čas události (eventTime),</li><li>Datum a čas změny (modified),</li><li>Zeměpisná šířka (latitude),</li><li>Zeměpisná délka (longitude),</li><li>Adresa (locality),</li><li>Ulice (roadDescription),</li><li>Město (city),</li><li>Stát (state),</li><li>Číslo nádoby (identCode),</li><li>Typ technologie (technologyType),</li><li>Činnost ramene (loaderArmCode),</li><li>Hmotnost obsahu (weight),</li><li>Id objektu (objectId).</li></ul><p>Události jsou ve implicitně seřazeny podle času uložení do DB sestupně.</p><p>Poznámka k práci se stránkováním: Business návrh abstrahuje od používání stránkování při volání API, které je zapotřebí zohlednit v technickém řešení, a to i v datové struktuře čekajících požadavků.</p><h2>ALG02: Založení čekajícího požadavku</h2><p>Do seznamu čekajících požadavků je založen nový záznam s těmito hodnotami:</p><ul><li>Zbývající počet opakování = <em>emptyContainerRetryCount</em>.</li><li>Čas od = hodnota z původně odeslaného požadavku.</li><li>Čas do = hodnota z původně odeslaného požadavku.</li></ul><h2>ALG03: Aktualizace čekajícího požadavku</h2><p>Záznam je aktualizován takto:</p><ul><li>Zbývající počet opakování je snížen o 1.</li></ul><h2>ALG04: Mapování atributů</h2><p>V rámci synchronizace je volán <a href="#" data-page-title="200UC30: Synchronizovat událost výsypu nádoby">200UC30: Synchronizovat událost výsypu nádoby</a>, specifikace hodnot vstupních parametrů včetně mapování je uvedena v tabulce.</p><table><tbody><tr><th>Vstupní parametr UC</th><th>Parametr z odpovědi API</th><th>Poznámka</th></tr><tr><td>Externí identifikátor</td><td>Id události (id)</td><td>–</td></tr><tr><td>Datum a čas události</td><td>Datum a čas události (eventTime)</td><td>–</td></tr><tr><td>Zeměpisná šířka</td><td>Zeměpisná šířka (latitude)</td><td>–</td></tr><tr><td>Zeměpisná délka</td><td>Zeměpisná délka (longitude)</td><td>–</td></tr><tr><td colspan="1">Lokalita</td><td colspan="1"><p>Adresa (locality)</p></td><td colspan="1">–</td></tr><tr><td colspan="1">Ulice lokality</td><td colspan="1">Ulice (roadDescription)</td><td colspan="1">–</td></tr><tr><td colspan="1">Město lokality</td><td colspan="1">Město (city)</td><td colspan="1">–</td></tr><tr><td colspan="1">Stát lokality</td><td colspan="1">Stát (state)</td><td colspan="1">–</td></tr><tr><td>Kód identifikátoru nádoby</td><td>Číslo nádoby (identCode)</td><td><p>Změna názvu parametru v odpovědi API.</p><p>Místo NULL může být obsažen i prázdný textový řetězec!</p></td></tr><tr><td colspan="1">Činnost ramene</td><td colspan="1">Činnost ramene (loaderArmCode)</td><td colspan="1">–</td></tr><tr><td colspan="1">Hmotnost obsahu</td><td colspan="1">Hmotnost obsahu (weight)</td><td colspan="1">–</td></tr><tr><td>Externí identifikátor objektu</td><td>Id objektu (objectId)</td><td> </td></tr><tr><td colspan="1">Je aktivní</td><td colspan="1">–</td><td colspan="1">Předána hodnota TRUE.</td></tr><tr><td>Zdroj změny</td><td>–</td><td>Předána hodnota Synchronizace (viz <a href="../../datove-modely/datovy-88033012.html">Zdroj změny</a>).</td></tr></tbody></table><h1>Validace</h1><h3>Validace záznamů o výsypech</h3><p>Jsou prováděny standardní validace jako:</p><ul><li>Povinné atributy nejsou null.</li><li>Správnost datového typu jednotlivých atributů.</li><li>Není překročen rozsah datového typu</li></ul><p>Požadavky kladené na jednotlivé atributy jsou zaznamenány v <a href="flwuc01-98239120.html">ALG04: Mapování atributů</a>.</p><h1>Revize</h1><h2>19. 12. 2022: Tomáš Nadrchal</h2><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1"><a href="flwuc01-98239120.html">ALG01: Parametry volání API</a></td><td colspan="1">Rozšíření popisu o nové parametry získané z API (naznačeno modře), viz změnové požadavky <strong>č. 127 </strong>(viz <a href="https://confluence.radium.cz/pages/viewpage.action?pageId=89066925">Rozvojové požadavky</a>).</td></tr><tr><td colspan="1"><a href="flwuc01-98239120.html">ALG04: Mapování atributů</a></td><td colspan="1">Rozšíření popisu o nové parametry volaného UC (naznačeno modře), viz změnové požadavky <strong>č. 127 </strong>(viz <a href="https://confluence.radium.cz/pages/viewpage.action?pageId=89066925">Rozvojové požadavky</a>).</td></tr></tbody></table><h2>13. 7. 2022: Tomáš Nadrchal</h2><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1"><a href="flwuc01-98239120.html">ALG01: Parametry volání API</a></td><td colspan="1">Rozšíření popisu o nové parametry získané z API (naznačeno modře), viz změnové požadavky <strong>č. 107 </strong>(viz <a href="https://confluence.radium.cz/pages/viewpage.action?pageId=89066925">Rozvojové požadavky</a>).</td></tr><tr><td colspan="1"><a href="flwuc01-98239120.html">ALG04: Mapování atributů</a></td><td colspan="1">Rozšíření popisu o nové parametry volaného UC (naznačeno modře), viz změnové požadavky <strong>č. 107 </strong>(viz <a href="https://confluence.radium.cz/pages/viewpage.action?pageId=89066925">Rozvojové požadavky</a>).</td></tr></tbody></table><h2>13. 9. 2021: Miroslav Slivoně</h2><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1">Plošné úpravy</td><td colspan="1"><p>Zapracovány připomínky z předání:</p><p>Doplněny Validace záznamů, EF03, ALG04.</p><p>Doplněn parametr <em>emptyingContainerSyncEnabled.</em></p></td></tr></tbody></table>
</div>
</body>
</html>

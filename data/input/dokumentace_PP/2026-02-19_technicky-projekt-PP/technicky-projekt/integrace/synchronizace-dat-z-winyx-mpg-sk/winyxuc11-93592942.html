<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>WinyxUC11: Synchronizovat nádoby pod řádkem smlouvy</title>
</head>
<body>
<div class="wiki-content">
<p></p><h1>Stručný popis, cíl</h1><p>Cílem případu užití je import přiřazení nádob k řádkům smluv z DB rozhraní WinyX. Odpovídající entitou v Pasportu je <a href="../../datove-modely/datovy-88033012.html">Přiřazení nádoby k položce objednávky</a>.</p><h1>Seznam aktérů</h1><table><tbody><tr><th>Aktér</th><th colspan="1">Poznámka</th></tr><tr><td colspan="1">Čas</td><td colspan="1">Systém spouští tento UC nepřímo spuštěním jiných UC.</td></tr></tbody></table><p>Poznámka: Úplný přehled aktérů je zobrazen samostatně, viz <a href="#" data-page-title="Přehled aktérů"></a>.</p><h1>Spuštění případů užití</h1><p>Případ užití je spouštěn v rámci <a href="#" data-page-title="WinyxUC01: Zahájit synchronizaci">WinyxUC01: Zahájit synchronizaci</a>.</p><h2>Vstupní podmínky</h2><p>Nejsou.</p><h2>Vstupní data</h2><ul><li>Data entity <strong>BCED_ContractItemContainer</strong> načtená z DB rozhraní Winyx.</li><li>Seznam Externích identifikátorů <a href="../../datove-modely/datovy-88033012.html">Provozoven</a>, pro které jsou data řádků smluv synchronizována (konfigurační parametr WinyX služby: <strong>contractItemContainerOrganizationalUnitsFilter</strong>).</li></ul><h1>Základní tok událostí</h1><ol><li>Systém provede kontrolu vstupních dat dle <a href="winyxuc11-93592942.html">VAL01: Validace vstupních dat</a> (<a href="winyxuc11-93592942.html">EF01: Nevalidní vstupní data</a>)</li><li>Systém takto připravené záznamy předá na rozhraní pro synchronizaci dat aplikace Pasport – zavolá <a href="#" data-page-title="200UC16: Synchronizovat přiřazení nádoby k položce objednávky"></a>, na vstupu jsou předány tyto informace:<br><ul><li>Data připravená dle <a href="winyxuc11-93592942.html">ALG01: Příprava vstupních dat</a><br><ul><li>Evidenční číslo nádoby <a href="../../datove-modely/datovy-88033012.html">Nádoby</a>.</li><li>Externí identifikátor <a href="../../datove-modely/datovy-88033012.html">Provozovny</a> k Nádobě.</li><li>Externí identifikátor <a href="../../datove-modely/datovy-88033012.html">Položky objednávky</a>.</li><li>Externí identifikátor <a href="../../datove-modely/datovy-88033012.html">Objednávky</a>.</li><li>Externí identifikátor <a href="../../datove-modely/datovy-88033012.html">Provozovny</a> k Položce objednávky.</li><li>Platnost od.</li><li>Platnost do.</li><li>Je aktivní.</li></ul></li><li>Zdroj změny: Synchronizace (viz <a href="../../datove-modely/datovy-88033012.html">Zdroj změny</a>)<em>.</em></li></ul></li><li>Systém zapíše do logu informaci o průběhu přenosu. V logu jsou uložena data:<br><ul><li>Datum a čas volání.</li><li>Plná data odchozího požadavku.</li><li>Návratový kód.</li><li>Případná chybová zpráva.</li></ul></li></ol><h1>Alternativní toky události</h1><p>Nejsou.</p><h1>Výjimkové toky událostí</h1><h3>EF01: Nevalidní vstupní data</h3><ol><li>Systém zaloguje informaci o nevalidních vstupních datech:<br><ul><li>Datum a čas.</li><li>Typ entity.</li><li>Identifikace záznamu.</li><li>Typ nalezené chyby.</li></ul></li><li>Systém daný záznam přeskočí a pokračuje ve zpracování.</li></ol><h1>Ukončení případu užití</h1><h2>Výstupní podmínky</h2><p>Proběhlo předání záznamů na rozhraní pro synchronizaci dat. </p><h2>Výstupní data</h2><p>Průběh přenosu byl zalogován.</p><h1>Algoritmy</h1><h2>ALG01: Příprava vstupních dat</h2><p>Objekt předávaný na synchronizační API aplikace Pasport je sestavený z dat na DB rozhraní (viz <a href="../synchronizace-93257926.html">Definice rozhraní</a>) dle níže uvedeného mapování, přičemž je aplikována filtrace daná parametrem <strong>contractItemContainerOrganizationalUnitsFilter</strong>. Odpovídající entitou Pasport je <a href="../../datove-modely/datovy-88033012.html">Přiřazení nádoby k položce objednávky</a>. Povinnost, datový typ a rozsah jsou uvedeny v datovém slovníku.</p><p>Samotný způsob synchronizace pak musí pracovat se skutečností, že se na DB rozhraní objevují z pohledu Pasport nevalidní záznamy (časově se překrývající vazby, viz <a href="#" data-page-title="136: Revize synchronizace přiřazení nádob k položkám objednávek">136: Revize synchronizace přiřazení nádob k položkám objednávek</a>). Jedná se o dočasné řešení, v rámci „přechodu na Helios“ bude odpovídající logika přenesena právě na ERP systém (výsledné řešení zatím není potvrzeno). Dočasně tedy při synchronizaci záznamů entity <strong>BCED_ContractItemContainter</strong> budeme postupovat následovně:</p><ol><li>Na rozhraní se objeví záznam s hodnotou atributu <strong>LastModified</strong> ve „sledovaném“ období (záznam má být synchronizován).</li><li>Systém vyhodnotí, zda se v Pasport již vyskytuje záznam s odpovídajícím externím identifikátorem (viz mapování dále).<ol><li>Pokud záznam již existuje, je způsob jeho synchronizace vyhodnocen následovně:<ol><li>Pokud se jedná záznam, který nás zajímá, proběhne jeho synchronizace běžným způsobem (předání na obecnou synchronizační komponentu).</li><li>Jinak nás záznam nezajímá, v tomto případě i tak proběhne jeho synchronizace s tím, že je záznam označen jako odebraný (předání na obecnou synchronizační komponentu, atribut <strong>Je aktivní</strong> nastaven na FALSE).</li></ol></li><li>Jinak záznam neexistuje, v takovém případě je způsob jeho synchronizace vyhodnocen následovně:<ol><li>Pokud se jedná záznam, který nás zajímá, proběhne jeho synchronizace běžným způsobem (předání na obecnou synchronizační komponentu).<br></li><li>Jinak nás záznam nezajímá, v takovém případě neproběhne ani jeho synchronizace (záznam <strong>není</strong> předán na obecnou synchronizační komponentu).</li></ol></li></ol></li></ol><p>Z pohledu tohoto algoritmu nás pak zajímají takové záznamy, které splňují všechny dále uvedené podmínky zároveň (viz <a href="winyxuc11-93592942.html">Příklad dostupných záznamů v aplikaci</a>):</p><ul><li>Hodnota atributu <strong>Status</strong> je rovna <strong>1</strong> (zajímají nás pouze aktivní záznamy).</li><li>Hodnota atributu <strong>TakenAwayDate</strong> splňuje alespoň jednu z dále uvedených podmínek:<br><ul><li>Hodnota není k dispozici (jedná se o vazbu s neomezenou platností).</li><li>Hodnota je větší nebo rovna pevně stanovenému datu: <strong>1. 10. 2022</strong> (jedná se o vazbu v nedávné minulosti).</li></ul></li></ul><p>Poznámka: Datum 1. 10. 2022 představuje období, kdy byla aplikace zpřístupňována externí zákazníkům, starší záznamy tedy není nutné aktuálně řešit (jedná se o dočasné řešení, do budoucna bude odpovídající logika řešena na straně ERP systému).</p><p>Interní poznámka: Před úvodní synchronizací bude nutné provést migraci dat (viz <a href="winyxuc11-93592942.html">Migrace dat</a>).</p><table><tbody><tr><th>Atribut DB rozhraní</th><th>Atribut na vstupu</th><th>Poznámka</th></tr><tr><td colspan="1"><p>BCED_ContractItemContainter.ContainerId</p><p>BCED_ContractItemContainter.ContainerOrganizationalUnitId</p><p>BCED_ContractItemContainter.ContractItemId</p><p>BCED_ContractItemContainter.ContractSubjectTypeId</p><p>BCED_ContractItemContainter.CustomerContractId</p><p>BCED_ContractItemContainter.ContractItemOrganizationalUnitId</p><p>BCED_ContractItemContainter.ContractItemSequence</p><p>BCED_ContractItemContainter.DeliveredDate</p></td><td colspan="1"><strong>Externí identifikátor</strong> entity <a href="../../datove-modely/datovy-88033012.html">Přiřazení nádoby k položce objednávky</a></td><td colspan="1"><p>Externí identifikátor je klíč složený z uvedených atributů. Položka <strong>BCED_ContractItemContainter.DeliveredDate</strong> je pak uvedena včetně časového razítka, jinak může docházet k duplicitnímu přiřazení externího identifikátoru k více záznamům současně (viz obrázek).</p><p><img src="winyxuc11-synchronizovat-nadoby-pod-radkem-smlouvy-93592942_images/image2023-7-4 8-52-43.png" data-attachment="true"></p></td></tr><tr><td><p>BCED_Container.EvidenceNumber</p><p>BCED_ContractItemContainter.ContainerOrganizationalUnitId</p></td><td><p><strong>Externí identifikátor</strong> entity <a href="../../datove-modely/datovy-88033012.html">Nádoba</a></p><p><em>Viz Poznámka 2.</em></p></td><td><p>Externí identifikátor je klíč složený z uvedených atributů</p><p>Evidenční číslo nádoby je dohledáno z tabulky Container.</p><p><em>SELECT EvidenceNumber from Container<br><em>WHERE Id = ContractItemContainter.ContainerId<br></em></em><em>AND ContainerOrganizationalUnitId = ContractItemContainter.ContainerOrganizationalUnitId</em></p><p>Hodnota je využívána k dohledání reference na Nádobu entity <a href="../../datove-modely/datovy-88033012.html">Přiřazení nádoby k položce objednávky</a>.</p><p>V rámci <a href="../../funkcionalni-specifikace/pripady-uziti/301ucxx-sprava-dat-nadoby/301uc01-88036162.html">301UC01: Založit nádobu</a> je do Externího identifikátoru nádoby nastavována hodnota <Evidenční číslo nádoby>:<Provozovna>. Tím pádem je možné dodatečně navázat k již existující nádobě v Pasportu příslušný řádek smlouvy.</p></td></tr><tr><td colspan="1"><p>BCED_ContractItemContainter.ContractItemId</p><p>BCED_ContractItemContainter.ContractSubjectTypeId</p><p>BCED_ContractItemContainter.CustomerContractId</p><p>BCED_ContractItemContainter.ContractItemOrganizationalUnitId</p></td><td colspan="1"><strong>Externí identifikátor</strong> entity <a href="../../datove-modely/datovy-88033012.html">Položka objednávky</a>.</td><td colspan="1"><p>Externí identifikátor je klíč složený z uvedených atributů</p><p>Hodnota je využívána k dohledání reference na Položku objednávky entity <a href="../../datove-modely/datovy-88033012.html">Přiřazení nádoby k položce objednávky</a>.</p><p>Na vstup jsou předány jen záznamy, kde <strong>ContractItemContainter.ContractItemOrganizationalUnitId</strong> odpovídá některé z hodnot obsažených v konfiguračním parametru <strong>contractItemContainerOrganizationalUnitsFilter</strong>.</p></td></tr><tr><td colspan="1">BCED_ContractItemContainter.DeliveredDate</td><td colspan="1">Platnost od</td><td colspan="1"><p>Ve WinyX údaj znamená přistavení na stanoviště, přičemž kontejner může být přistavován opakovaně. Na DB rozhraní je údaj součástí primárního klíče.</p><p>V Pasport je údaj využitý ve významu počátek platnosti přiřazení k Položce objednávky.</p><p>V případě, že existuje více záznamů lišících se v DeliveredDate, je importován nejnovější aktivní záznam - tj. záznamy jsou seřazeny <strong>sestupně</strong> primárně podle Status, sekundárně podle DeliveredDate.</p><p>Všechny vazby importovány nejsou, protože na rozhraní se někdy mohou časově překrývat – takové záznamy by neprošly validací v Pasport. Jedná se pak o záznamy v „dávné“ minulosti – ty mohou být ignorovány (dočasné řešení). Odpovídající chování bylo popsáno dříve.</p><p>Viz také <a href="winyxuc11-93592942.html"><em>Příklad - výběr řádku smlouvy</em></a>.</p></td></tr><tr><td colspan="1">BCED_ContractItemContainter.TakenAwayDate</td><td colspan="1">Platnost do</td><td colspan="1"><p>V Pasport je údaj využitý ve významu konec platnosti přiřazení k Položce objednávky.</p><p>I zde musíme brát v potaz časově se překrývající záznamy, logika je pak obdobná jako u atributu <strong>DeliveredDate</strong>. Odpovídající chování bylo popsáno dříve.</p></td></tr><tr><td colspan="1">BCED_ContractItemContainter.Status</td><td colspan="1">Je aktivní</td><td colspan="1">–</td></tr></tbody></table><p>Poznámka: Atribut<strong> BCED_ContractItemContainter.ContractItemSequence</strong> není v integraci používaný, vazba <a href="../../datove-modely/datovy-88033012.html">Přiřazení nádoby k položce objednávky</a> je utvářena k položce objednávky bez ohledu na konkrétní revizi. Z určitých důvodů se však atribut nově stal součástí externího identifikátoru synchronizované vazby (viz <a href="#" data-page-title="136: Revize synchronizace přiřazení nádob k položkám objednávek">136: Revize synchronizace přiřazení nádob k položkám objednávek</a>).</p><p>Poznámka 2: WinyX v případě vytvoření navazujícího pořadí řádku smlouvy <strong>přesune vazby na nově vzniklý řádek smlouvy</strong>. Tento přesun proběhne okamžitě, nezávisí na nastavené platnosti nového řádku smlouvy. Na rozhraní je ukončena platnost vazeb na původní řádek smlouvy.</p><h3>Příklad dostupných záznamů v aplikaci</h3><p>Pro úplnost je uveden také příklad synchronizace v případě, kdy pro jednu dvojici nádoby s položkou objednávky existuje na DB rozhraní více záznamů současně. V potaz jsou tedy brány pouze záznamy (entita BCED_ContractItemContainer), které splňují všechny dále uvedené podmínky zároveň:</p><ul><li>Hodnota atributu <strong>Status</strong> je rovna <strong>1</strong> (zajímají nás pouze aktivní záznamy).</li><li>Hodnota atributu <strong>TakenAwayDate</strong> splňuje alespoň jednu z dále uvedených podmínek:<br><ul><li>Hodnota není k dispozici (jedná se o vazbu s neomezenou platností).</li><li>Hodnota je větší nebo rovna pevně stanovenému datu: <strong>1. 10. 2022</strong> (jedná se o vazbu v nedávné minulosti).</li></ul></li></ul><table><tbody><tr><td colspan="1"><strong>Je předáno</strong></td><td colspan="1"><strong>Nádoba (složený klíč)</strong></td><td colspan="1"><strong>Položka objednávky (složený klíč)</strong></td><td colspan="1"><strong>Status</strong></td><td colspan="1"><strong>DeliveredDate</strong></td><td colspan="1"><strong>TakenAwayDate</strong></td></tr><tr><td colspan="1"></td><td colspan="1"><strong>XXX</strong></td><td><strong>YYY</strong></td><td><strong>1</strong></td><td><strong>1. 1. 2023</strong></td><td><strong>NULL</strong></td></tr><tr><td colspan="1"></td><td colspan="1"><strong>XXX</strong></td><td><strong>YYY</strong></td><td><strong>1</strong></td><td><strong>1. 7. 2020</strong></td><td><strong>31. 12. 2022</strong></td></tr><tr><td colspan="1"></td><td>XXX</td><td>YYY</td><td>1</td><td>1.1.2013</td><td>30.6.2017</td></tr><tr><td colspan="1"></td><td>XXX</td><td>YYY</td><td>0</td><td>1.10.2022</td><td>31.10.2022</td></tr><tr><td colspan="1"></td><td>XXX</td><td>YYY</td><td>0</td><td>1.11.2022</td><td>NULL</td></tr></tbody></table><p><em>Poznámka: Pro lepší pochopení změny je uveden stejný příklad, ve kterém je ale naznačeno stávající chování (před implementací požadované změny). </em></p><table><tbody><tr><td colspan="1"><em><strong>Je předáno</strong></em></td><td colspan="1"><em><strong>Nádoba (složený klíč)</strong></em></td><td colspan="1"><em><strong>Položka objednávky (složený klíč)</strong></em></td><td colspan="1"><em><strong>Status</strong></em></td><td colspan="1"><em><strong>DeliveredDate</strong></em></td><td colspan="1"><em><strong>TakenAwayDate</strong></em></td></tr><tr><td colspan="1"><em></em></td><td colspan="1"><em><strong>XXX</strong></em></td><td><em><strong>YYY</strong></em></td><td><em><strong>1</strong></em></td><td><em><strong>1. 1. 2023</strong></em></td><td><em><strong>NULL</strong></em></td></tr><tr><td colspan="1"><em></em></td><td colspan="1"><em>XXX</em></td><td><em>YYY</em></td><td><em>1</em></td><td><em>1. 7. 2020</em></td><td><p>31. 12. 2022</p></td></tr><tr><td colspan="1"><em></em></td><td><em>XXX</em></td><td><em>YYY</em></td><td><em>1</em></td><td><em>1.1.2013</em></td><td><em>30.6.2017</em></td></tr><tr><td colspan="1"><em></em></td><td><em>XXX</em></td><td><em>YYY</em></td><td><em>0</em></td><td><em>1.10.2022</em></td><td><em>31.10.2022</em></td></tr><tr><td colspan="1"><em></em></td><td><em>XXX</em></td><td><em>YYY</em></td><td><em>0</em></td><td><em>1.11.2022</em></td><td><em>NULL</em></td></tr></tbody></table><h3>Migrace dat</h3><p>Důležitým krokem implementace je provedení migrace dat – zda musíme rozlišovat 2 typy informací…</p><ul><li><strong>Synchronizované záznamy</strong> – záznamy byly získány synchronizací z WinyX.<br><ul><li>Záznamy <strong>mají</strong> k dispozici Externí identifikátor, současně je zdroj vytvoření nastaven na hodnotu Synchronizace.</li><li><strong>Takové záznamy jsou v Pasport smazány</strong>, budou totiž opětovně nahrány v rámci iniciální synchronizace.</li></ul></li><li><strong>Zadané záznamy</strong> – záznam byl zadán přímo uživatele, byl importován v rámci jednorázové akce nebo byl zadán administrátorským záznamem.<br><ul><li>Záznamy <strong>nemají</strong> k dispozici Externí identifikátor, současně je zdroj vytvoření nastaven na <strong>jinou</strong> hodnotu než Synchronizace.</li><li><strong>Takové záznamy jsou v Pasport zachovány</strong>, není totiž možné je opětovně získat z WinyX.</li></ul></li></ul><p>Případné problémy (překryv období synchronizovaných a zadaných záznamů) budou řešeny až v rámci samotné migrace.  </p><p>Interní poznámka: V rámci migrace je vhodné provést zálohu aktuálně existujících dat.</p><h5><em><strong>Příklad - výběr řádku smlouvy</strong></em></h5><p><em>Záznamy se vztahují ke stejné nádobě a stejné položce objednávky (nikoli k revizi položky objednávky - nezávisí tedy na hodnotě Sequence).</em></p><p><em>Záznamy jsou seřazeny dle Status sestupně (tj. na začátku jsou aktivní záznamy, pokud existují), sekundárně jsou řazeny dle DeliveredDate sestupně (tj. nejdříve nejmladší záznamy).</em></p><p><em>V uvedeném případě je tedy nádoba přiřazena k řádku <strong>od 1.12.2020 do neomezeně</strong>. Nevýhodou je, že v Pasportu dochází ke ztrátě informace, že nádoba byla přiřazena ke smlouvě již 1.1.2013, ale tento nedostatek zákazník akceptuje. Jedná se o dočasné řešení, v Helios bude řešeno lépe.</em></p><table><tbody><tr><th colspan="1"><em>Složený klíč - Nádoba</em></th><th><em>Složený klíč - Položka objednávky</em></th><th>Status</th><th><p>DeliveredDate</p></th><th>TakenAwayDate</th></tr><tr><td colspan="1"><strong>XXX</strong></td><td><strong>YYY</strong></td><td><strong>1</strong></td><td><strong>1.12.2020</strong></td><td><strong>NULL</strong></td></tr><tr><td colspan="1">XXX</td><td>YYY</td><td>1</td><td>1.7.2020</td><td>30.11.2020</td></tr><tr><td>XXX</td><td>YYY</td><td>1</td><td> 1.1.2013</td><td> 30.6.2017</td></tr><tr><td>XXX</td><td>YYY</td><td>0</td><td>1.10.2022 </td><td>31.10.2022 </td></tr><tr><td>XXX</td><td>YYY</td><td>0</td><td>1.11.2022 </td><td>NULL </td></tr></tbody></table><h1>Validace</h1><h2>VAL01: Validace vstupních dat</h2><ul><li>Všechny povinné položky jsou vyplněny.</li><li>Vyplněné položky jsou správného datového typu a v povoleném rozsahu.</li></ul><h1>Revize</h1><h2>4. 7. 2023: Tomáš Nadrchal</h2><p>Revize způsobu nastavení externího identifikátoru (naznačeno růžově).</p><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1"><a href="winyxuc11-93592942.html">ALG01: Příprava vstupních dat</a></td><td colspan="1">Revize způsobu nastavení externího identifikátoru (naznačeno růžově).</td></tr></tbody></table><h2>13. 4. 2023: Tomáš Nadrchal</h2><p>Návrh řešení je uveden samostatně, viz <a href="#" data-page-title="136: Revize synchronizace přiřazení nádob k položkám objednávek"></a>.</p><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1"><a href="winyxuc11-93592942.html">ALG01: Příprava vstupních dat</a></td><td colspan="1">Revize algoritmu pro vyhodnocení synchronizovaných záznamů (naznačeno modře).</td></tr><tr><td colspan="1"><a href="winyxuc11-93592942.html">Příklad - výběr řádku smlouvy</a></td><td colspan="1">Odebrání neaktuálního příkladu chování (naznačeno modře).</td></tr></tbody></table><h2>30. 11. 2022: Miroslav Slivoně</h2><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1"><p><a href="winyxuc11-93592942.html">ALG01: Příprava vstupních dat</a></p></td><td colspan="1"><p>Změna vyhodnocení Platnosti od a Platnosti do v případě vazby nádoba - položka objednávky. Podle DeliveredDate již nebude řazeno vzestupně, ale sestupně - tj. předán bude záznam s nejnovějším přistavením. </p><p>(Ztrácí se údaj o prvním přistavení, ale zákazník toto akceptuje, přizpůsobujeme se povaze dat na rozhraní.)</p></td></tr></tbody></table><h2>04. 10. 2021: Miroslav Slivoně</h2><table><tbody><tr><th>Odkaz</th><th>Stručný popis změny</th></tr><tr><td colspan="1">–</td><td colspan="1">Doplnění podpory pro filtraci provozoven, pro která budou data synchronizována (parametr contractItemContainerOrganizationalUnitsFilter)</td></tr></tbody></table>
</div>
</body>
</html>

<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Logovanie</title>
</head>
<body>
<div class="wiki-content">
<div class="ak-renderer-extension  "><div class="ak-renderer-extension-overflow-container"><div class="css-1y8lsgj e1ihjts80"><div class="toc-macro client-side-toc-macro  conf-macro output-block hidden-outline"><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Konceptu%C3%A1lna-architekt%C3%BAra">Konceptuálna architektúra</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Komponenty">Komponenty</a><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Log-Forwarder">Log Forwarder</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Log-Aggregator">Log Aggregator</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Log-Data-Storage">Log Data Storage</a></li></ul></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#HW-infra%C5%A1trukt%C3%BAra">HW infraštruktúra</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#In%C5%A1tal%C3%A1cia-a-konfigur%C3%A1cia">Inštalácia a konfigurácia</a><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Fluentbit">Fluentbit</a><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#In%C5%A1tal%C3%A1cia-Fluentbit">Inštalácia Fluentbit</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Konfigur%C3%A1cia-Fluentbit">Konfigurácia Fluentbit</a></li></ul></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#EFK-stack">EFK stack</a><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Postup-in%C5%A1tal%C3%A1cie-EFK">Postup inštalácie EFK</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#FluentD">FluentD</a><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#System">System</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Source">Source</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Filter">Filter</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Match">Match</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Label">Label</a></li></ul></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Elasticsearch">Elasticsearch</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Kibana">Kibana</a><ul><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Index-pattern">Index pattern</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Lifecycle-policy">Lifecycle policy</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Index-template">Index template</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Saved-search">Saved search</a></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Dashboards">Dashboards</a></li></ul></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#Kibana-Management----Konceptu%C3%A1lna-architekt%C3%BAra">Kibana Management - Konceptuálna architektúra</a></li></ul></li></ul></li><li><a href="https://ai-maps.atlassian.net/wiki/spaces/OF/pages/5099946009/Logovanie+radium#In%C5%A1trukt%C3%A1%C5%BEne-video">Inštruktážne video</a></li></ul></div></div></div></div><h1>Konceptuálna architektúra </h1><p>Konceptuálna architektúra logovania ktorá je použitá pri vývoji systému ale aj v produkčnom prostredí.</p><div class="ak-editor-panel sc-dfVpRl bOGGVY"><div class="ak-editor-panel__icon"><img src="logovanie-106136331_images/image2022-4-28 13-28-47.png" data-attachment="true"></div><div class="ak-editor-panel__icon"><p> </p><div class="ak-editor-panel sc-dfVpRl bOGGVY"><div class="ak-editor-panel__content"><p>Aplikačné servery nemusia presne korešpondovať reálnej situácii pri vývojovej infraštruktúre</p></div></div><p> </p></div></div><p><strong>Application Docker Container - </strong>jedná sa o komponent systému ktorý beží v rámci Docker containeru</p><h1>Komponenty </h1><p>Tu je len uvedený stručný prehľad aké technológie sú použité.</p><h2>Log Forwarder </h2><p>Úlohou je zbierať výstupy procesov, konkrétne z docker containerov, ktoré následne presmeruje na hlavný log aggregator.</p><ul><li><p>technológia: <strong>Fluentbit</strong></p></li></ul><h2>Log Aggregator </h2><p>Zbiera správy z jednotlivých log forwarderov, správy sparsuje do JSON formátu a na základe typu správy ukladá do konkrétnych indexov v ElasticSearch</p><ul><li><p>technológia: <strong>Fluentd</strong></p></li></ul><h2>Log Data Storage </h2><p>Ako storage logov je použitý <strong>ElastichSearch</strong>, ktorý ukladá log správy v jednotlivých indexoch a nad nimi je spravená vizualizácia v podobe dashboardov v <strong>Kibana</strong>.</p><h1>HW infraštruktúra </h1><div class="pm-table-container  sc-kpOJdX kAzjOl"><p> </p><table><tbody><tr><th colspan="1" rowspan="1"><div class="ak-renderer-tableHeader-sortable-column__button"><p><strong>Komponent</strong></p></div></th><th colspan="1" rowspan="1"><div class="ak-renderer-tableHeader-sortable-column__button"><p><strong>Version</strong></p></div></th><th colspan="1" rowspan="1"><div class="ak-renderer-tableHeader-sortable-column__button"><p><strong>IP</strong></p></div></th><th colspan="1" rowspan="1"><div class="ak-renderer-tableHeader-sortable-column__button"><p><strong>Port</strong></p></div></th><th colspan="1" rowspan="1"><div class="ak-renderer-tableHeader-sortable-column__button"><p><strong>Umiestnenie suborov</strong></p></div></th><th colspan="1" rowspan="1"><div class="ak-renderer-tableHeader-sortable-column__button"><p><strong>Volume</strong></p></div></th></tr><tr><td colspan="1" rowspan="1"><p>Elasticsearch</p></td><td colspan="1" rowspan="1"><p><code>7.14.0</code></p></td><td colspan="1" rowspan="1"><p>192.168.77.38</p></td><td colspan="1" rowspan="1"><p>14001</p></td><td colspan="1" rowspan="1"><p>/flww/logging</p></td><td colspan="1" rowspan="1"></td></tr><tr><td colspan="1" rowspan="1"><p>Kibana</p></td><td colspan="1" rowspan="1"><p><code>7.14.0</code></p></td><td colspan="1" rowspan="1"><p>192.168.77.38</p></td><td colspan="1" rowspan="1"><p>14003</p></td><td colspan="1" rowspan="1"><p>/flww/logging</p></td><td colspan="1" rowspan="1"><p> </p></td></tr><tr><td colspan="1" rowspan="1"><p>FluentD</p></td><td colspan="1" rowspan="1"><p><code>v1.11.0-1.0</code></p></td><td colspan="1" rowspan="1"><p>192.168.77.38</p></td><td colspan="1" rowspan="1"><p>14000</p></td><td colspan="1" rowspan="1"><p>/flww/logging</p></td><td colspan="1" rowspan="1"></td></tr><tr><td colspan="1" rowspan="1"><p>Fluentbit</p></td><td colspan="1" rowspan="1"><p><code>1.4.5</code></p></td><td colspan="1" rowspan="1"><p>192.168.77.49</p></td><td colspan="1" rowspan="1"><p>24224 (Docker)</p></td><td colspan="1" rowspan="1"><p>/home/aimaps/fluentbit</p></td><td colspan="1" rowspan="1"></td></tr><tr><td colspan="1" rowspan="1"><p>Fluentbit</p></td><td colspan="1" rowspan="1"><p><code>1.4.5</code></p></td><td colspan="1" rowspan="1"><p>192.168.78.40</p></td><td colspan="1" rowspan="1"><p>24224 (Docker)</p></td><td colspan="1" rowspan="1"><p>/home/aimaps/fluentbit</p></td><td colspan="1" rowspan="1"></td></tr><tr><td colspan="1" rowspan="1"><p>Fluentbit</p></td><td colspan="1" rowspan="1"><p><code>1.4.5</code></p></td><td colspan="1" rowspan="1"><p>192.168.77.47</p></td><td colspan="1" rowspan="1"><p>24224 (Docker)</p></td><td colspan="1" rowspan="1"><p>/home/aimaps/fluentbit</p></td><td colspan="1" rowspan="1"><div class="code-block sc-cmTdod lgZzvS"></div></td></tr></tbody></table><p> </p></div><h1>Inštalácia a konfigurácia </h1><h2>Fluentbit </h2><p>Fluent bit je jednoduchý log forwarder nainštalovaný na aplikačnom serveri z ktorého preposiela logy z jednotlivých aplikačných komponentov do log agregátora (FluentD).</p><p>Potrebné súbory:</p><ul><li><p>docker-compose.yml</p></li><li><p>fluentbit.conf</p></li></ul><h3>Inštalácia Fluentbit </h3><p>Fluent bit sa inštaluje pomocou docker-compose.</p>true<p>Konfigurácia Fluentbit </p>true<p>Odkaz na fluentbit dokumentaciu - <a href="https://docs.fluentbit.io/manual/administration/configuring-fluent-bit">https://docs.fluentbit.io/manual/administration/configuring-fluent-bit</a></p><p> </p><p>Sekcia SERVICE</p><div class="fabric-editor-block-mark fabric-editor-indentation-mark"><ul><li>Interné nastavenia Fluentbit service</li></ul></div><ul><li><ul><li><p>Flush - Ako často má fluentbit forwardovať log správy</p></li><li><p>Daemon - či má bežať FluentBit ako background process (off pre použitie s Docker)</p></li><li><p>Log_level - Log level interných správ Fluentbit</p></li></ul></li></ul><p>INPUT</p><div class="fabric-editor-block-mark fabric-editor-indentation-mark"><ul><li>Nastavenie endpointu na ktorom FluentBit prijma log správy</li></ul></div><p>OUTPUT</p><div class="fabric-editor-block-mark fabric-editor-indentation-mark"><ul><li>Nastavenie kam a aké správy má FluentBit posielať</li></ul></div><h2>EFK stack </h2><p>Elasticsearch Kibana a FluentD sú inštalované spoločne cez docker-compose v ktorom sú jednotlivé services definované</p><p>Potrebné súbory v nasledovnej súborovej štruktúre</p><ul><li><p>docker-compose.yml</p></li><li><p>fluentd</p><ul><li><p>Dockerfile</p></li><li><p>conf</p><ul><li><p>fluent.conf</p></li></ul></li></ul></li></ul><h3>Postup inštalácie EFK </h3><div class="code-block sc-cmTdod lgZzvS"><p> </p>Docker Composetrue<p> </p></div><div class="sc-dUjcNx fsaVOa"><div class="sc-eilVRo fWEqRM"><div class="expand-content-wrapper"><div class="sc-bdVaJa jGgciL"><div class="code-block sc-cmTdod lgZzvS"><p> </p>Dockerfiletrue<p> </p></div></div></div></div></div><h3>FluentD </h3><p>Pri zmene konfiguračného súboru fluent.conf je potrebné vykonať reštart docker kontajneru s FluentD komponentom napr. <code>docker restart efk_stack_fluentd_main</code></p><p>Popis konfiguračného súboru</p><p><a href="https://docs.fluentd.org/configuration/config-file">https://docs.fluentd.org/configuration/config-file</a></p>fluent.conftrue<p><br></p><p>System </p><div class="code-block sc-cmTdod lgZzvS"><p> </p><p> </p></div><p>V tejto sekcii je definované ako má FluentD poskytovať interné logy</p><h4>Source </h4><div class="code-block sc-cmTdod lgZzvS"><p> </p><p> </p></div><p>Definuje kde FluentD počúva na pricházdajúce logy</p><ul><li><p>@type forward - Definuje možnosť TCP endpoint</p></li><li><p>port - Port na ktorom fluentD počúva (Tento port je potrebné namapovať na úrovni docker v sekcii ports; v momentálnej konfigurácii je namapovaný na host port 14000 )</p></li></ul><h4>Filter </h4><p>Používa sa pre transformáciu alebo úpravu log správ</p>Priklad filter sekcietrue<p> </p><p>Syntax a dostupné atribúty sú závislé od typu filtra.</p><p>Spoločné pre všetky filtre je spôsob akým sa určuje pre ktoré logy sa má filter použiť. To určuje pattern v začiatočnom tagu sekcie, napr. <code><filter **></code> (použiť pre všetky logy) alebo <code><filter pasport.**></code> (použiť pre logy ktorých tag sa začína <code>pasport.</code>) rovnako to platí aj pre match sekciu. Podrobne popísané tu <a href="https://docs.fluentd.org/configuration/config-file#wildcards-expansions-and-other-tips">https://docs.fluentd.org/configuration/config-file#wildcards-expansions-and-other-tips</a></p><p>V konfigurácii sú použité dva typy filtrov, concat a parser</p><p><strong>Concat filter</strong></p><p>Spája dlhé logy ktoré boli rozdelené na niekoľko častí Docker logging driverom. Docker logging driver má obmedzenie na 14000 znakov pre jeden log, ak je log správa dlhšia docker logging driver správu rozdelí a pripojí meta údaje o počte a poradí čiastkových správ, tento filter na základe týchto meta dat čiastkové správy opat spojí naspäť do jednej.</p><p><strong>Parser filter</strong></p><p>Log správy prichádzajú ako plain text, tento filter parsuje text do požadovaného formátu.</p><p>Použitý typ parseru json.</p><p> </p><h4>Match </h4><p>Sekcia zachytí log a pošle ho na nakonfigurovaný endpoint. V tomto prípade elasticsearch</p>Príklad a vysvetlenie parametrov Match sekcietrue<p> </p><div class="sc-dUjcNx fsaVOa"><div class="sc-eilVRo fWEqRM"><div class="expand-content-wrapper"><div class="sc-bdVaJa jGgciL"><div class="code-block sc-cmTdod lgZzvS">  </div></div></div></div></div><p>V tejto konfigurácii FluentD vytvára nový index v elasticsearch každý deň (<code>logstash_format true</code>)</p><h4>Label </h4><p>Spája filter a match do jedného bloku pre lepšiu prehľadnosť. následne sa label použije napríklad volaním <code>@label @roadplan_mpg_production</code></p>Priklad label sekcietrue<p> </p><p> </p><h3>Elasticsearch </h3><p>Elasticsearch indexy sú vytvárané automaticky podla konfigurácie FluentD (sekcia match - @type elasticsearch)</p><p>Ostatne nastavenia su ovladane z Kibana (Lifecycle policy, number of replicas …)</p><p>Iné nastavenia je možné posielať cez elastic rest API, buď priamo z Kibana alebo cez Curl a podobné nástroje</p><h3>Kibana </h3><p>Okrem prvotnej konfigurácie pri inštalácii kde sa kibane povie s akými údajmi sa má pripojiť k elasticserch, sa všetky nastavenia vykonávajú pomocou web GUI.</p><h4>Index pattern </h4><p>Všetky log správy, ktoré sú odoslané do Elasticsearch, patria do indexov. Na vyhľadávanie údajov pomocou Kibana je potrebné vybrať, ktorý index alebo indexy je potrebné zahrnúť.<br>Túto konfiguráciu je možné spraviť vytvorením index patternu. Index pattern je reťazec znakov ktorý sa porovnáva s názvami Elasticsearch indexov<br>Index pattern sa môže zhodovať s názvom jedného indexu alebo môže obsahovať wildcards (*), aby sa zhodovali viaceré indexy.</p><h4>Lifecycle policy </h4><p>Určuje čo sa má s Elasticsearch indexom diať počas jeho životnosti. V rámci tejto konfigurácie sú lifecycle policies používané na odstránenie starých indexov (vytvorené sú lifecycle policies pre odstránenie indexov po 15 , 30 a 90 dňoch) pre uvoľnenie úložnej kapacity disku a zníženie počtu elasticsearch shards ktoré sú limitované nastavením samotnej ES databázy.</p><p>Lifecycle policies sa pripájajú do index templates. nie je moźné ich pripojiť na indexy ktoré nie sú súčasťou index template.</p><h4>Index template </h4><p>Je súbor nastavení ktoré sa majú aplikovať na novovytvorený index. Index templates sa aplikujú na základe index patterns, to znamená že každý index template má určené inddex templates pre ktoré bude aplikovaný, vždy keď sa vytvoí nový index elasticsearch ho skúsi priradiť na základe index patternu k index template a upraví nastavenia indexu. V tejto konfigurácii je index templates používaný na priradenie Lifecycle policies k indexu a tieź k nastaveniu počtu replík daného indexu. (Počet replík indexu je nastavený na 1 keďže sa jedná o single node ES)</p><h4>Saved search </h4><p>Kibana umožňuje ukladanie filtrov a jednotlivých vyhladávaní vrátane zvolených stĺpcov a výsledkov nad index patternami. Tieto uložené vyhľadávania a filtrovania môžu byť následne použité pri tvorbe dashboardov.</p><h4>Dashboards </h4><p>Umožňujú vizualizovať dáta zo zozbieraných logov v podobe grafov a tabuliek.</p><h3>Kibana Management - Konceptuálna architektúra </h3><p>Diagram znázorňuje koncept ukladania a následnej vizualizácie logov z pohľadu ElasticSearch. Sú tu znázornené kompoenenty ktoré sa podielajú na tvorbe finálnych dashboardov. Diagram nezahŕňa všetky varianty pre jednotlivý typy logov ale len niektoré. Pod diagramom je popísaný detail jednotlivých častí.</p><div class="ak-renderer-extension  "><div class="ak-renderer-extension-overflow-container"><div class="css-1y8lsgj e1ihjts80"><div class="ap-container conf-macro output-block"><div class="ap-content "><div class="ap-iframe-container iframe-init"><img src="logovanie-106136331_images/log storage concept.drawio.png" data-attachment="true"></div></div></div></div></div></div><p><br><br>Inštruktážne video </p><p>Vid priloha "kibana.zip"</p><p> </p>
</div>
</body>
</html>

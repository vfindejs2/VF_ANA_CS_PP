<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Deployment</title>
</head>
<body>
<div class="wiki-content">
<p>Deployment prebieha pomocou docker-compose. V docker-compose súbore sú uvedené jednotlivé parametre pre spustenie docker kontajnerov jednotlivých komponentov. Premenné pre docker-compose a jednotlivé komponenty sú v súboroch .env .</p><p>Konfiguračné parametre (<a href="#" data-page-title="Konfiguračné parametre nasadenia"></a>) pre docker-compose a jednotlivé kontajnery sú v súboroch <em>.en</em>v. Súbory <em>.env </em>sa nachádzajú v rámci GIT repozitára <strong>deployment</strong>. Každé samostatné nasadenie systému má v rámci deployment repozitáru vlastný priečinok v ktorom sa nachádza <strong><em>docker-compose.yml</em></strong> aplikačného stacku (Backend, Frontend, Sync service, Database migration, Fileserver), <strong><em>docker-compose-winyx_sync_service.yml </em></strong>pre nasadenie winyx sync service a jednotlivé <em><strong>.env</strong> súbory.</em></p><p>Docker images sa nacházdajú v registry dockerhub.ai-maps.com<em>  </em>namespace radium-pasport.</p><p>Príklad jednotlivých docker images komponentov:</p><ul><li><em> </em>docker pull dockerhub.ai-maps.com/radium-pasport/backend:1.2.1-0-g773aa5e</li><li>docker pull dockerhub.ai-maps.com/radium-pasport/database-migration:1.2.1-0-g5a146c3</li><li>docker pull dockerhub.ai-maps.com/radium-pasport/database-winyx-migration:1.2.0-0-gd2ee427</li><li>docker pull dockerhub.ai-maps.com/radium-pasport/frontend:1.2.1-0-g60d87d0a</li><li>docker pull dockerhub.ai-maps.com/radium-pasport/sync-service:1.2.1-0-g2ed70d2</li><li>docker pull dockerhub.ai-maps.com/radium-pasport/winyx-sync-service:1.2.1-0-g36f28b1</li></ul><p>Nasadenie aplikácie prebieha v štyroch krokoch.</p><ol><li>Spustenie databázovej migrácie</li><li>Deployment aplikačného stacku</li><li><a href="#" data-page-title="Postup postinštalačnej konfigurácie"></a></li><li>Deployment winyx sync service</li></ol><h3>Prerequisite</h3><ul><li>Príprava konfiguračných parametrov a docker-compose súborov na základe dokumentácie<a href="#" data-page-title="Konfiguračné parametre nasadenia"></a>.</li><li>Docker registry sa definuje priamo v docker-compose.yml a docker-compose-winyx_sync_service.yml. V rámci env premenných sa definuje iba názov docker image za lomítkom URL docker registry</li><li>Pred deployom aplikácie je potrebné mať nakopírované jednotlivé súbory potrebné pre deploy na požadovanom serveri.<br><ul><li>Potrebné súbory:<br><ul><li>docker-compose.yml</li><li>docker-compose-winyx_sync_service.yml</li><li>.env, backend.env, db_migration.env, flww_api.env, flww_rabbit.env, frontend.env, minio.env, primary_db.env, sync-service.env, winyx_db_migration.env, winyx_db.env,winyx-sync-service.env - Bližšie popísané v sekcii Konfiguračné parametre</li></ul></li></ul></li><li>Kontrola jednotlivých súborov a konfiguračných parametrov</li></ul><p> </p><h3>Definovanie verzií komponentov ktoré majú byť nasadené</h3><p>v súbore <code><strong>.env</strong></code> je potrebné nastaviť požadované verzie komponentov na základe release-notes. Jedná sa o jednotlivé tagy docker image-ov ktoré sa majú spustiť.</p><p>Jednotlivé parametre verzií komponentov a príklad hodnoty</p><div><ul><li>BACKEND_VERSION=1.1.1-5-g1ca8289</li><li><div>FRONTEND_VERSION=1.1.1-10-g28d6126e</div></li><li><div>SYNC_SERVICE_VERSION=1.1.0-1-gfec376b</div></li><li><div>DB_VERSION=1.1.0-0-g7d89046</div></li><li><div>WINYX_SYNC_SERVICE_VERSION=1.1.0-0-gbf3ff32</div></li><li><div>WINYX_DB_VERSION=1.1.0-0-gd2ee427</div></li></ul></div><h3>Spustenie databázovej migrácie</h3><p>Spočíva v automatizovanom spustení databázových skriptov ktoré vytvoria a/alebo upravia databázový model pridajú potrebné dáta (napr. číselníky), vytvoria views, indexy a podobne.</p><p>Spustením databázovej migrácie sa skontroluje či je databáza aktualizovaná na požadovanú verziu. Pri prvom spustení databázovej migrácie sa spustia všetky dostupné databázové skripty, pri následných spusteniach databázovej migrácie sa kontroluje ktoré skripty nad databázou uz spustené boli a spustia sa iba tie ktoré chýbaju (napríklad pri upgrade verzie).</p><p>V adresári v ktorom sa nachádzajú potrebné súbory je potrebné spustiť docker-compose command ktorý spustí databázovú migráciu.</p>db=migration commandbash<h3>Deployment aplikačného stacku</h3><p>Po úspešnej databázovej migrácii je potrebné v rovankom adresári spustiť docker-compose príkaz pre Deploy aplikačného stacku.</p><p>Definícia potrebných docker kontajnerov je v súbore <em><strong>docker-compose.yml</strong></em></p><div><p> </p>deploy app stackbash<p>Tento príkaz spustí docker kontajnery definované v docker-compose.yml <strong>OKREM</strong> kontajnera s databázovou migráciou (--scale database-migration=0)</p><h3>Deployment winyx sync service</h3><p><img src="http://confluence.ai-maps.com/s/en_US/8100/b0984b7297905b7c7bd946458f753ce0130bfc8c/_/images/icons/emoticons/warning.svg"> pred deployom winyx sync service jo potrebné mať vykonanú <a href="#" data-page-title="Postup postinštalačnej konfigurácie">postinštalačnú konfiguráciu</a> </p><p> </p></div><div>Má dve časti</div><ol><li>Spustenie databázovej migrácie pre winyx databázu</li><li>Deployment winyx sync service</li></ol><p>Definícia potrebných docker kontajnerov je v súbore <em><strong>docker-compose-winyx_sync_service.yml</strong></em></p><p>Databázová migrácia pre winyx databázu má rovnaký princíp ako databázova migrácia pre primárnu databázu aplikačného stacku. Spustí sa nasledovným príkazom:</p><div><p> </p>deploy winyx DB migrationbash<p>Následne je možné spustiť deploy winyx sync service</p>deploy winyx sync sevicebash<p><br><br></p></div>
</div>
</body>
</html>

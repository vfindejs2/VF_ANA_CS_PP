<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Synchronizácia dát z externých systémov</title>
</head>
<body>
<div class="wiki-content">
<p>Dokument popisuje základné charakteristiky synchronizácie dát do systému Pasport z externých systémov. V rámci jednotlivých podstránok je popis synchronizácie vzhľadom na konkrétny externý systém.</p><p></p><h1>Synchronizačné komponenty a ich interakcie</h1><p>Jadro synchronizácie predstavuje pasport komponent <strong>sync-service</strong>, ktorá má vystavené REST API cez ktoré je možné synchronizovať dáta do systému Pasport.</p><p>Popis tohto REST API je tu <a href="https://confluence.radium.cz/wiki/spaces/FP/pages/4962912228">Synchronizacna komponenta API</a></p><ul><li><p>v rámci popisu API je vidieť aké všetky entity je možné synchronizovať do pasportu</p></li><li><p>hlavným obmedzením API je počet záznamov ktoré je možné v rámci jedného požiadavku synchronizovať - aktuálne 200</p></li></ul><p> </p><div><p><strong>Koncept synchronizácie z externých systémov je, že sú budované samostatné synchronizačné služby pre daný externým systém, ktoré komunikujú so sync-service</strong></p><p>Tieto samostatné synchronizačné služby sú samostatne nasadzované, pričom sync-service nemá na ne žiadnu závislosť. Závislosť je opačná, teda externá synchronizačná info musí mať definovanú integráciu na sync-service. (táto informácia je napr. na úrovni nasadenia danej služby)</p></div><p>Tok synchronizácie z externého systému do systému Pasport:</p><p><img src="synchronizacia-dat-z-externych-systemov-98241937_images/passport_sync_schema.drawio.png" data-attachment="true"></p><p> </p><p> </p><p>Pod externým zdrojom dát si môžeme predstaviť zdroj vo forme databázy, REST API, a pod. To akou formou je realizovaná integrácia s týmto zdrojom, je čisto v kompetencii "synchronizačnej služby externých dát".</p><p> </p><ul><li><p>synchronizačná služba externých dát <strong>[sync-external]</strong> vyhodnocuje, ktoré entity majú byť synchronizované na základe dát z <strong>Externého dátového zdroja </strong></p></li><li><p>sync-external riadi nadväznosť synchronizacií závislých entít</p></li><li><p>sync-external volá passport synchronizačnú službu <strong>[sync-service]</strong> pomocou REST API volaní</p></li><li><p>sync-service vyhodnocuje, ktoré entity updatuje, príp. insertuje do <strong>Passport DB</strong> na základe spoločného identifikátora</p><ul><li><p>atribút <strong>external_id</strong> ktorý má každá entita určená na synchronizáciu</p></li></ul></li><li><p>sync-service odpovedá sync-external identifikátormi entít, ktoré boli, resp. neboli zosynchronizované</p></li><li><p>sync-external spracováva informácie o synchronizovaných, resp. nesynchronizovaných entitách</p></li></ul><h1>Proces synchronizácie z externého systému do systému Pasport</h1><ol><li><p>[<em>sync-external</em>] Začiatok synchronizácie / synchronizačného cyklu (CRON, volanie API, ..)</p></li><li><p>[<em>sync-external</em>] Log [Info] začatie synchronizácie (čas, komponent, ...)</p></li><li><p>[<em>sync-external</em>] Synchronizácia entít v poradí určenom na základe ich nadväzností</p><ol><li><p>[<em>sync-external</em>] Synchronizácia entity</p></li><li><p>[<em>sync-external</em>] Log [Info] synchronizácia entity (čas, komponenta, typ entity, ...)</p></li><li><p>[<em>sync-external</em>] Určenie dotknutých entít (na základe externého dát. zdroja)</p></li><li><p>[<em>sync-external</em>] Volanie [sync-service] synchronizačného API (komponenta, typ entity, dáta) [*]</p></li><li><p>[<em>sync-service</em>] Validácia prijatých dát (typ entity, entity) z pohľadu povinných atribútov, prípadne dátových typov → Log [Error], filtrácia validných entít</p></li><li><p>[<em>sync-service</em>] Upsert entít do Passport DB jednotlivo [*] → Log [Warning] entity, ktoré neprejdu</p></li><li><p>[<em>sync-service</em>] Log [Info] ukončenie synchronizácie entity (čas, zdrojová komponenta, typ entity, optional - id synchronizovaných entít) </p></li><li><p>[<em>sync-service</em>] Vrátenie zoznamu identifikátorov synchronizovaných, resp. nesynchronizovaných entít (neprešli validáciou + neprešli upsertom, možno vracať aj dôvod)</p></li><li><p>[<em>sync-external</em>] Vyhodnotenie synchronizácie entity (zaznamenanie, ktoré boli/neboli synchronizované)</p></li><li><p>[<em>sync-external</em>] Log [Info] ukončenie synchronizácie entity (čas, komponenta, typ entity, ...)</p></li><li><p>[<em>sync-external</em>] ↻ Nasledujúce entity...</p></li></ol></li><li><p>[<em>sync-external</em>] Log [Info] ukočenie synchronizácie / synchronizačného cyklu (čas, komponent, ...)</p></li></ol><p>* Pri väčšom množstve dát volať po dávkach - treba špecifikovať množstvo</p><h1>Zoznam entít ktoré je možné synchronizovať</h1><ul><li><p><a href="https://confluence.radium.cz/wiki/spaces/FP/pages/4962912228">Synchronizacna komponenta API</a></p></li></ul><table><tbody><tr><th><p>Typ entity</p></th><th><p>entity_name</p></th></tr><tr><td><p>Adresa</p></td><td><p>address</p></td></tr><tr><td><p>Nádoba</p></td><td><p>container</p></td></tr><tr><td><p>Kategória nádoby</p></td><td><p>container_category</p></td></tr><tr><td><p>Farba nádoby</p></td><td><p>container_color</p></td></tr><tr><td><p>Materiál nádoby</p></td><td><p>container_material</p></td></tr><tr><td><p>Vzor nádoby</p></td><td><p>container_pattern</p></td></tr><tr><td><p>Typ nádoby</p></td><td><p>container_type</p></td></tr><tr><td><p>Stanovisko</p></td><td><p>site</p></td></tr><tr><td><p>Priradenie nadoby ku stanovisku</p></td><td><p>site_container_assignment</p></td></tr><tr><td><p>Druh odpadu</p></td><td><p>garbage_type</p></td></tr><tr><td><p>Frekvencia vývozu</p></td><td><p>waste_disposal_frequency</p></td></tr><tr><td><p>Základne dni zvozu</p></td><td><p>waste_disposal_day</p></td></tr><tr><td><p>Zákazník</p></td><td><p>customer</p></td></tr><tr><td><p>Objednávka</p></td><td><p>order</p></td></tr><tr><td><p>Polozka objednavky</p></td><td><p>order_item</p></td></tr><tr><td><p>Revizia polozky objednavky</p></td><td><p>order_item_revision</p></td></tr><tr><td><p>Priradenie nadoby k polozke objednavky</p></td><td><p>container_order_item_assignment</p></td></tr></tbody></table><h1>Logovanie sync-service</h1><p> </p><p>Synchronizačná komponenta loguje nasledovné procesy:</p><p> </p><table><tbody><tr><th><p>Proces</p></th><th><p>Popis</p></th><th><p>Poznámka</p></th></tr><tr><td><p>Celková synchronizácia </p></td><td><p>V prípade ak je zavolané API pre účely synchronizácie určitej entity, logujeme začiatok, koniec a prípadné zlyhanie tohto procesu</p></td><td><p> </p></td></tr><tr><td><p>Synchronizácia entity</p></td><td><p>Stav synchronizácie konkrétnej entity - v zmysle či prebehlo správne, alebo tam je chyba, prípadne validačný problém</p><p> </p></td><td><p> </p></td></tr></tbody></table><p>Základné atribúty log správy ktorý je vidieť v kibane:</p><table><tbody><tr><th><p>Parameter</p></th><th><p>Príklad hodnoty</p></th><th><p>Popis</p></th></tr><tr><td><p><strong>COMPONENT_NAME</strong></p></td><td><p>sync-service</p></td><td><p>názov synchronizačnej komponenty</p></td></tr><tr><td><p><strong>msg</strong></p></td><td><p>[SYNC_PROCESS_STATUS]: Sync 'customer' finished</p></td><td><p>správa je konštruovaná podľa patternu: </p><p> </p><pre><code>[{{code}}]: {{message}} </code></pre><p> </p></td></tr><tr><td><p><strong>log</strong></p></td><td><p> </p><pre><code>{ syncLoggingCode: "SYNC_PROCESS_STARTED", syncProcessId: "0d4968d0-2928-4439-b0ce-3fa1acc9ea00", data: { callerComponent: "WINYX", entityType: "customer", tenantId: 232, timestamp: "2021-08-04T09:15:04.803Z", ... } version: "dev", project: "FLWWPASPORT", component: "sync-service", environment: "-" }</code></pre><p> </p></td><td><p>Základné atribúty logu</p><ul><li><p>syncLoggingCode - kód logovacieho procesu</p></li><li><p>syncProcessId - jednoznačný identifikátor procesu (vysvetlenie v rámci <a href="#">Synchronizácia dát z externých systémov#Identifik%C3%A1torprocesusynchroniz%C3%A1cie(syncProcessId)</a>)</p></li><li><p>data - tu sú detailné metadata daného logu. Pre každý log sú spoločné tieto:</p><ul><li><p>callerComponent - názov služby ktorá mohla volať sync-service</p></li><li><p>entityType - názov entity ktorá bola synchronizovaná, viď tabuľka vyššie (atribút "entity_name")</p></li><li><p>tenantId - id tenanta pre ktorého sa majú dáta uložiť</p></li><li><p>timestamp - čas akcie</p></li></ul></li></ul></td></tr><tr><td><p> </p></td><td><p> </p></td><td><p> </p></td></tr></tbody></table><h3>Identifikátor procesu synchronizácie (syncProcessId)</h3><p>Sync-service REST API podporuje posielať parameter "processId" pre každé volanie, ktoré následne ukladáme do všetkých logov. V prípade ak sa nepošle - Sync service si vytvorí vlastný procesId.</p><p>Parameter slúži primárne pri zisťovaní prípadných problémoch v logoch, kedy budeme potrebovať pozrieť logy zo synchronizačnej služby externých dát (sync-external) a z tejto obecnej sync-service. Tým pádom budeme vedieť prepojiť procesy z oboch služieb.</p><h2>Logované procesy</h2><p>Detailný popis pre každý proces je popísaný nižšie s ukážkami jednotlivých logov a ako tieto logy filtrovať.</p><h3>Celková synchronizácia </h3><p>V prípade ak je zavolané API pre účely synchronizácie určitej entity, logujeme začiatok, koniec a prípadné zlyhanie tohto procesu.</p><p> </p><div><p>V tomto procese nás zaujíma vyhľadať konkrétny stav procesu synchronizácie pre nejaký typ entity (napr. či skončil úspešne stav synchronizácie entít zákazníkov)</p></div><p> </p><table><tbody><tr><th><p>Field</p></th><th><p>Operator</p></th><th><p>Values</p></th><th><p>Popis</p></th></tr><tr><td><p>COMPONENT_NAME</p></td><td><p>is</p></td><td><p><strong>sync-service</strong></p></td><td><p> </p></td></tr><tr><td><p>syncLoggingCode</p></td><td><p>is</p></td><td><p><strong>SYNC_PROCESS_SUCCESS</strong></p></td><td><p><strong>SYNC_PROCESS_STARTED </strong>- proces synchronizácie začal</p><p><strong>SYNC_PROCESS_SUCCESS</strong> - proces synchronizácie skončil úspešne</p><p><strong>SYNC_PROCESS_FAILED</strong> - proces synchronizácie skončil s chybou</p></td></tr><tr><td><p>data.entityType</p></td><td><p>is</p></td><td><p><strong>customer</strong></p></td><td><p>viď <strong>entity_name</strong> v tabuľke vyššie</p></td></tr></tbody></table><p>Príklad logu:</p><p> </p><table><tbody><tr><th><p>Parameter</p></th><th><p>Hodnota</p></th><th><p>Popis</p></th></tr><tr><td><p><strong>msg</strong></p></td><td><p>[SYNC_PROCESS_SUCCESS]: Sync 'customer' finished</p></td><td><p> </p></td></tr><tr><td><p><strong>log</strong></p></td><td></td><td><p>špecifické atribúty v rámci "data":</p><ul><li><p>entityExternalIds - zoznam externých identifikátorov entít ktoré vstupovali do procesu</p><ul><li><p>pri ostatných typoch správ by sa malo jednať vždy o rovnaké externé id. Nie sú su id ktoré sa nasynchronizovali správne.</p></li></ul></li></ul></td></tr></tbody></table><p> </p><h3>Synchronizácia entity</h3><p>Stav synchronizácie konkrétnej entity - v zmysle či prebehlo správne, alebo tam je chyba, prípadne validačný problém</p><div><p>V tomto procese nás zaujíma vyhľadať konkrétny stav procesu synchronizácie konkrétnej entity (napr. či skončil úspešne stav synchronizácie entity zákazníka ktorý vyhľadáme podľa externého identifikátora)</p></div><p> </p><table><tbody><tr><th><p>Field</p></th><th><p>Operator</p></th><th><p>Values</p></th><th><p>Popis</p></th></tr><tr><td><p>COMPONENT_NAME</p></td><td><p>is</p></td><td><p><strong>sync-service</strong></p></td><td><p> </p></td></tr><tr><td><p>syncLoggingCode</p></td><td><p>is</p></td><td><p><strong>SYNC_ENTITY_SUCCESS</strong></p></td><td><p><strong>SYNC_ENTITY_SUCCESS</strong> - proces synchronizácie entity skončil úspešne</p><p><strong>SYNC_ENTITY_VALIDATION_FAILED </strong>- proces synchronizácie entity skončil s chybou validácie</p><p><strong>SYNC_ENTITY_FAILED </strong>- proces synchronizácie entity skončil s chybou</p></td></tr><tr><td><p>data.entityType</p></td><td><p>is</p></td><td><p><strong>customer</strong></p></td><td><p>viď <strong>entity_name</strong> v tabuľke vyššie</p></td></tr><tr><td><p>data.entityExternalId</p></td><td><p>is</p></td><td><p><strong>123</strong></p></td><td><p>externý identifikátor entity</p></td></tr><tr><td><p>data.syncOperation</p></td><td><p>is</p></td><td><p><strong>create</strong></p><p> </p></td><td><p>ak chceme vidieť len určitú operáciu synchronizácie</p><p><strong>create</strong> - entita bola vytvorená</p><p><strong>update</strong> - entita bola zeditovaná</p><p><strong>delete</strong> - entita bola vymazaná</p><p> </p></td></tr></tbody></table><p>Príklad logu:</p><p> </p><table><tbody><tr><th><p>Parameter</p></th><th><p>Hodnota</p></th><th><p>Popis</p></th></tr><tr><td><p><strong>msg</strong></p></td><td><p>[SYNC_ENTITY_SUCCESS]: Entity 'customer' [customer_aimaps_16] is synced</p></td><td><p>Hodnota [customer_aimaps_16] je externe id entity</p></td></tr><tr><td><p><strong>log</strong></p></td><td><pre> </pre></td><td><p>špecifické atribúty v rámci "data":</p><ul><li><p>syncOperation - o akú operáciu synchronizácie entity sa jednalo</p><ul><li><p>create</p></li><li><p>update</p></li><li><p>delete</p></li></ul></li><li><p>entityData - pre príslušnú operáciu tu budú dáta entity</p><ul><li><p>pri "create" - entita z externého systému</p></li><li><p>pri "update" - pôvodná entita z DB pasportu a editovaná entita z externého systému</p></li><li><p>pri "delete" - pôvodná entita z DB pasportu a zmazávaná entita z externého systému</p></li></ul></li><li><p>entityExternalId - identifikátor entity z externého systému</p></li></ul></td></tr></tbody></table><p> </p><p> </p>
</div>
</body>
</html>

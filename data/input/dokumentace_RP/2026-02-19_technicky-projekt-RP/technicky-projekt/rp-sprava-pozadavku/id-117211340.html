<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>ID-048: Integrace mapových služeb CEDA</title>
</head>
<body>
<div class="wiki-content">
<p></p><h1>Požadavek</h1><p>Aplikace RoadPlan má podporovat mapové služby od CEDA v rozsahu: zobrazení mapy, geokóding a routing. </p><h1>Aktuální stav</h1><h4>Mapy</h4><p>Front-end aplikace používá komponentu <a href="#" data-page-title="700UI01: Komponenty – mapa"></a>, která podporuje zobrazování různých mapových podkladů. </p><p>Pro získání seznamu podporovaných pokladů je z front-endu volán endpoint FLWW2 API<strong><em> /configuration/maps</em></strong>, který poskytuje seznam map k zobrazení včetně relevantních nastavení. První položka ze seznamu odpovídá výchozí mapě.</p><p>Aplikace v současnosti podporuje pouze rastrové dlaždicové mapy, podpora pro vektorové dlaždice zatím chybí. </p><h4>Geokóding</h4><p>Aplikace RoadPlan podporuje geokóding služby od Planstudio (na jejichž formátu je postavena také <a href="#" data-page-title="flw-geoservice">flw-geoservice</a>).</p><p>Geokóding je používaný jak na backendu (např. <a href="#" data-page-title="600UC03: Automatický geokóding adres">600UC03: Automatický geokóding adres</a> , <a href="#" data-page-title="706UC01: Získat adresu dle souřadnic"></a>), tak na front-endu (např. <a href="#" data-page-title="500UC07: Založit místo realizace"></a>).</p><p>URL pro geokóding je zadána v konfiguračním souboru aplikace (tedy mimo databázové konfigurační parametry). V současnosti je volán napřímo geoserver Planstudio, nevyužívá se geoservice ani geo-endpointy na FLWW2 API, které jsou pod autorizací. </p><p>V databázi existuje parametr g<em>eocodeCountry</em> v tabulce <em>default_settings</em>, který umožňuje omezit vyhledávání adres na území zadaného státu.</p><p>Pro účely volání z front-endu je URL získána z odpovědi volání RP API <em><strong>/settings/settings.json</strong></em>.</p><p><em>Pozn.: Současná dokumentace (viz <a href="#" data-page-title="706UC01: Získat adresu dle souřadnic"></a>) RP již počítá s voláním geo-endpointů na FLWW2 API. Na produkci se zatím nepoužívá, v připravované verzi se FLWW2 API volá, ale zatím jen z front-endu.</em></p><h4>Routing</h4><p>RoadPlan v současnosti podporuje výhradně <a href="https://project-osrm.org/">OSRM</a> routing. Důvodem pro jeho výběr byla podpora truck atributů.</p><p>Nastavení související s routingem jsou zadána v konfiguračních souborech aplikace a v kódu (tedy mimo databázové konfigurační parametry). Jedinou výjimkou je parametr <em>routingCriterion</em>, který se zadává v DB tabulce <em>default_settings</em>.</p><p>Součástí nasazení RoadPlan je OSRM routing server + mapová data (OSM), která jsou vygenerována pro konkrétní parametry vozidla (tzv. routing profile). OSRM disponuje <a href="https://project-osrm.org/docs/v5.24.0/api/">HTTP API</a>.</p><p>Konfigurační soubor (routing profile) pro OSRM viz <a href="#" data-page-title="Aplikační prostředí"></a>.</p><p>Z front-endu není voláno přímo OSRM API, používají se endpointy RP API, např. <em><strong>/orderedServiceLocations/route</strong></em> nebo <em><strong>/dayPerformanceData/update</strong></em>, které v odpovědi vracejí výstupy routingu (jako vzdálenosti, doby trvání, geometrii trasy). </p><h1>Návrh řešení</h1><p>V rámci integrace map CEDA bude brán zřetel na následující:</p><ul><li>Důraz na standardizaci řešení, tj. FLWW2 i externí moduly budou držet stejnou linii.</li><li>Použití obecných knihoven, které bude možné sdílet mezi externími aplikacemi Fleetware (pokud je to v daném případě efektivní). </li><li>Zachování podpory pro OSRM routing coby alternativního řešení.</li></ul><p>Návrh je dále struktrován dle jednotlivých skupin mapových služeb.</p><h2>Mapy</h2><p>Bude zachován stávající způsob získávání dostupných map z FLWW2 API endpointu <strong><em>/configuration/maps</em></strong>.</p><p>Pro účely zavedení podpory vektorových dlaždic a jejich odlišení od map rastrových byl zaveden atribut <em><strong>type</strong></em> nabývající hodnot {standard, vector}.</p><p>Jinak zůstává struktura odpovědi stejná a pro vektorovou mapu CEDA může příslušný objekt vypadat takto:</p><p><em>Pozn.: Přístupový token je součástí urlTemplete a ačkoli je uživateli aplikace přístupný, nejedná se o použití v rozporu s best practices CEDA.</em></p><p>Zavedení podpory pro CEDA mapy tak spočívá v níže popsané implementaci jejich vektorových map.</p><p>Dokumentace CEDA je dostupná zde: <a href="https://developers.ceda.cz/docs/vector-tile-api">https://developers.ceda.cz/docs/vector-tile-api</a>.</p><h5>Zapracování do Leaflet</h5><p>Leaflet standardně nepodporuje vektorové dlaždice a je proto nutné použít další knihovnu.</p><p>Ukázky s použitím Maplibre a Mapboxu: </p><ul><li></li><li></li></ul><p>Kód v Angularu:</p><p><em>Poznámka: Protože je použitý styl ve specifikaci od Mapboxu/Maplibre, tak Protomaps v Leafletu nebudou fungovat.</em></p><h2>Geokóding</h2><p>Zůstává zachována podpora pro parametr <em>geocodeCountry</em> v tabulce <em>default_settings</em>, který umožňuje omezit vyhledávání adres na území zadaného státu.</p><h6>Volání z front-endu</h6><p>Pro potřeby volání z FE bude využíván endpoint FLWW2 API <em><strong>/geocoding</strong></em>. Tento endpoint se používá stejně jako Planstudio geokóding, ale je nutné volat ho s FLWW2 access tokenem.</p><p>Na pozadí probíhá volání <a href="#" data-page-title="flw-geoservice">flw-geoservice</a>, která funguje jako proxy služba provolávající geocoging službu nastavenou pro FLWW2 (CEDA nebo jiná podporovaná služba).</p><p><strong>Volání z backendu</strong></p><p>Pro potřeby volání z backendu bude rovněž voláno FLWW2 API <em><strong>/geocoding</strong></em>, ale pod systémovým uživatelem.</p><p><em>Pozn.: Alternativně by bylo možné volat přímo <a href="#" data-page-title="flw-geoservice">flw-geoservice</a>, v případě CEDA providera je podporována basic autentizace nebo autentizace proti Identity Server. Tato druhá možnost by vyžadovala separátní nastavení volané služby.</em></p><h2>Routing</h2><p>Bude zachována možnost využívat OSRM routing ve stávající podobě. Pokud však bude dané nasazení RoadPlan využívat jiný routing, není nutné, aby součástí nasazení byl také OSRM server.</p><p>Úpravy se týkají jen backendu, protože front-end nevolá přímo routing, ale dedikované endpointy RP API.</p><p>Nově se v případě CEDA routingu<strong> předává datum a čas odjezdu z bodu tak, aby mohl být zohledněný typický traffic</strong>. <em>Bude řešeno v navazující fázi na základě separátního požadavku.</em></p><h3>Konfigurace</h3><p>Konfigurace RP bude rozšířena tak, aby bylo možné nastavit využívaný routing. K tomuto účelu budou rozšířeny <a href="#" data-page-title="Konfigurační hodnoty"></a>.</p><table><tbody><tr><th>Hodnota</th><th colspan="1">Úroveň nastavení</th><th>Význam</th><th colspan="1">Výchozí hodnota</th></tr><tr><td>routingSettings</td><td colspan="1">Nasazení/Klient</td><td>Komplexní nastavení pro routing</td><td colspan="1"><p>Odpovídá OSRM routingu</p></td></tr><tr><td colspan="1">routingCriterion</td><td colspan="1">Nasazení/Klient</td><td colspan="1"><p>Určuje způsob, kterým bude hledána cesta v grafu – specifikace účelové funkce.</p><p>Tento existující parametr bude zrušen a nahrazen novým komplexním nastavením.</p></td><td colspan="1">CAR_FASTEST_PAYED</td></tr></tbody></table><h5>Nastavení používaná pro providera CEDA</h5><p>Součástí nastavení je parametr apiKey. Jedná se o přístupový token, který se liší od tokenu používaného pro účely zobrazení map (kde je součástí URL). Tento token bude používaný pouze pro volání z backendu a je tak skrytý před uživateli aplikace.</p>CEDA nastavení<h3>Použití CEDA API </h3><p>Dokumentace CEDA routingu: <a href="https://developers.ceda.cz/docs/routing-api">https://developers.ceda.cz/docs/routing-api</a></p><p>Bude využíván endpoint <em><strong>/routing/{area}</strong></em>.</p><p>Parametry volání:</p><table><tbody><tr><th>Parametr</th><th>Hodnota</th><th>Komentář</th></tr><tr><td>area</td><td>dle konfigurace</td><td><p>Dle výchozí konfigurace nebude routing vracet výsledky mimo území CZ / SK.</p><p>Aktuálně CEDA nemá pokrytí sousedních zemí. Hodnota "eur" podléhá vyššímu zpoplatnění.</p></td></tr><tr><td>routingMode</td><td>dle konfigurace</td><td>Hodnota "truck" podléhá vyššímu zpoplatnění. V základní sazbě hodnota "car".</td></tr><tr><td>routingType</td><td>dle konfigurace</td><td> </td></tr><tr><td>from</td><td>dynamicky v dotazu</td><td>Souřadnice počátečního bodu trasy ve formátu latitude, longitude.</td></tr><tr><td colspan="1">via</td><td colspan="1">dynamicky v dotazu</td><td colspan="1">Souřadnice průjezdního bodu nebo bodů trasy ve formátu latitude, longitude. Omezeno na max. 5 bodů.</td></tr><tr><td colspan="1">to</td><td colspan="1">dynamicky v dotazu</td><td colspan="1">Souřadnice cílového bodu trasy ve formátu latitude, longitude.</td></tr><tr><td colspan="1">compress</td><td colspan="1">yes</td><td colspan="1"><em>Předpokládáme využití výhod komprese, v rámci implementace je ale možno přehodnotit.</em></td></tr><tr><td colspan="1">weight</td><td colspan="1">dle konfigurace</td><td colspan="1"> </td></tr><tr><td colspan="1">height</td><td colspan="1">dle konfigurace</td><td colspan="1"> </td></tr><tr><td colspan="1">width</td><td colspan="1">dle konfigurace</td><td colspan="1"> </td></tr><tr><td colspan="1">length</td><td colspan="1">dle konfigurace</td><td colspan="1"> </td></tr><tr><td colspan="1">traffic</td><td colspan="1">dle konfigurace<em><br></em></td><td colspan="1"> </td></tr><tr><td colspan="1">date</td><td colspan="1"><p>dynamicky v dotazu</p><p>—</p></td><td colspan="1">Datum a čas předáván, pokud hodnota parametru traffic = "stats".</td></tr><tr><td colspan="1">fromLevel</td><td colspan="1">—</td><td colspan="1"> </td></tr><tr><td colspan="1">viaLevel</td><td colspan="1">—</td><td colspan="1"> </td></tr><tr><td colspan="1">toLevel</td><td colspan="1">—</td><td colspan="1"> </td></tr><tr><td colspan="1">avoid</td><td colspan="1">dle konfigurace</td><td colspan="1"> </td></tr><tr><td colspan="1">splitByLevel</td><td colspan="1">—</td><td colspan="1"> </td></tr><tr><td colspan="1">splitByType</td><td colspan="1">—</td><td colspan="1"> </td></tr></tbody></table><h3>Logování</h3><p>Aplikace RoadPlan bude logovat jednotlivé dotazy na routing.</p><p>Příslušný log bude zpracováván do ELK pro RoadPlan. </p><h2>Negativní vymezení</h2><ul><li>Nově nebude možné, aby FLWW2 používal jiný geokóding než aplikace RoadPlan, která přebírá nastavení geokódingu z FLWW2. </li><li>Na straně FLWW2 není připravena standardizovaná proxy služba pro routing (obdoba <a href="#" data-page-title="flw-geoservice">flw-geoservice</a>), případný vznik takové služby bude předmětem samostatného projektu.</li><li>Ačkoli CEDA routing umožňuje zadat parametry trasy vozidla (truck atributy) na úrovni jednotlivého dotazu (nemá jeden statický routing profile jako OSRM), není tato možnost v současné podobě návrhu využita. Systém nemá informaci o parametrech jednotlivých vozidel.</li><li>V první fázi nebude pracováno s informací o datu a času odjezdu - typickými průjezdními dobami. (Bude řešeno navazujícím požadavkem.)</li></ul><h1>Akceptační testy</h1><p>Pro splnění požadavku musí být splněny následující testovací scénáře.</p><h2>TC01: Zobrazení map CEDA</h2><ol><li>Systém umožňuje v rámci mapové komponenty zobrazit mapové podklady CEDA.</li></ol><h2>TC02: Geokóding pomocí CEDA služby</h2><ol><li>Systém vykonává jednotlivé funkce geokódingu podporované v rámci aplikace RoadPlan s využitím služby CEDA.</li></ol><h2>TC03: Routing pomocí CEDA služby</h2><ol><li>Systém vykonává jednotlivé funkce routingu podporované v rámci aplikace RoadPlan s využitím služby CEDA.<ul><li>Zohledňuje přitom nastavené parametry nákladního vozidla (truck atributy).</li><li>Pro výpočet doby trvání trasy využívá údaje o obvyklém provozu (stats).</li></ul></li></ol><h1>Poznámka</h1><p>–</p>
</div>
</body>
</html>

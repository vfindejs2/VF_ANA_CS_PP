<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>ID-084: Přímé vyhodnocení realizace objednané služby dle informací z tabletu</title>
</head>
<body>
<div class="wiki-content">
<p></p><h1>Požadavek</h1><p>Cílem požadavku je implementace pokročilého vyhodnocení realizace objednaných služeb dle informací z vozidlového tabletu – označení lokace objednané služby jako realizované v tabletu provede její přímé označení ve webové aplikaci.</p><h1>Aktuální stav</h1><p>Aktuální chování vychází ze stávající logiky vyhodnocení realizace objednaných služeb – probíhá tedy na úrovni sledování specifikovaného HW vstupu konkrétního vozidla. Celý proces vypadá následovně:</p><ol><li>Uživatel označí ve vozidlovém tabletu lokaci objednané služby jako realizovanou.</li><li>Vozidlový tablet zajistí vytvoření aktivace definovaného HW vstupu (k dispozici je pouze informace o poloze a době trvání).<br><ul><li>Aktivace vstupu se dostává do FLWW2.</li></ul></li><li>RoadPlan získá nové aktivace vstupů z FLWW2, které na úrovni jednotlivých vozidel vyhodnotí (porovná polohu aktivací vstupu vzhledem k lokacím objednaných služeb přiřazených k danému vozidlu).</li></ol><p><img src="id-084-prime-vyhodnoceni-realizace-objednane-sluzby-dle-informaci-z-tabletu-114460676_images/image2023-3-22 19-57-1.png" data-attachment="true"></p><h1>Návrh řešení</h1><p>Návrh řešení musí zohlednit jak úpravu chování na úrovni vozidlového tabletu (aplikace FOB), tak v aplikaci RoadPlan.</p><h2>Webová aplikace</h2><p>Začneme webovou aplikací, kde musíme požadavek řešit hned na několika úrovních…</p><ul><li><strong>Správa vozidel</strong> – na úrovni jednotlivých vozidel musí být možné specifikovat, který zdroj bude využit pro vyhodnocení realizace objednaných služeb.</li><li><strong>Komunikace s FOB</strong> – rozšíření komunikace o nový typ zprávy (párování informací z FOB na konkrétní lokace objednaných služeb).</li><li><strong>Vyhodnocení realizace</strong> – rozšíření algoritmu pro vyhodnocení realizace objednaných služeb (různý zdroj informací → PTO, FOB).</li><li><strong>Uživatelské rozhraní</strong> – jako vhodné se jeví doplnění informace také na uživatelské rozhraní. Dispečer má pak přehled, u jakých vozidel je realizace přímo potvrzována řidičem. </li></ul><h3>Správa vozidel</h3><p>Abychom byli schopni vyhodnotit, jaký zdroj bude při vyhodnocení realizace objednaných služeb na úrovni daného vozidla využit (vždy je vyhodnocován <strong>právě</strong> jeden zdroj), musí dojít k rozšíření datového modelu.</p><ul><li>Entita <strong>Vozidlo</strong> bude rozšířena o atribut specifikující zdroj informací (nový výčtový typ, hodnoty pak mohou vypadat následovně: PTO, FOB).<br><ul><li>Bude se jednat o nepovinný údaj, který bude vyplňován pouze u vozidel, pro která jsou generovány denní výkony (pokud u takového vozidla nebude informace vyplněna, použije se výchozí hodnota).</li><li>Poznámka: Pokud bychom chtěli tuto informaci zadávat s časovou platností, musí být řešeno jako samostatná tabulka (nikoliv pouze atribut řešené entity).</li></ul></li><li>Informace bude v první fázi zadávána na úrovni administrátorského zásahu (výchozí hodnota: <strong>PTO</strong>).<br><ul><li>Po změně hodnoty musí být aktualizovány odpovídající denní výkony. Dle toho musí být zvolen také způsob, jakým bude administrátorský zásah proveden. </li><li>Na úrovni vozidla v RP musí být vždy nastaven aktuálně používaný způsob vyhodnocení realizace (zadáváno bez nastavení platnosti → změny musí být prováděny současně nebo po osazení tabletem).</li><li>Nastavení vozidla v RP není přímo propojeno s vozidlem, nastavení zdroje informací je tedy pevně dané (bez ohledu na to, zda je vozidlo např. osazeno tabletem).</li><li>Informace o způsobu vyhodnocení realizace je pak brána v potaz také při generování denních výkonů (včetně jejich přegenerování např. při editaci vozidla).<br><ul><li>Ověřit :Pokud dojde ke změně vozidla (např. SPZ, typ dopravy), proběhne současně také přegenerování denních výkonů? Nebo je nutné vyvolat akci ručně (případně počkat na noční provedení akce)?</li></ul></li><li>Tato informace nesmí být přepisována při synchronizaci vozidel (aktuálně je zdrojem informace pouze aplikace RP).</li></ul></li><li>Následně (v další fázi) může být zadání informace přeneseno na uživatele (zadání v RoadPlan, získání z FLWW2…). </li></ul><p>Poznámka: Další úpravy datového modelu jsou popsány v části s vyhodnocením realizace (např. evidence informací o realizaci objednaných služeb). </p><h3>Komunikace s FOB</h3><p>Aby bylo z FOB možné získat všechny potřebné informace o realizaci objednané služby, musíme rozšířit komunikační protokol o nový typ zprávy. Ta obsahuje především následující informace:</p><ul><li>identifikátor lokace objednané služby (párování informací z FOB a RP),</li><li>stav realizace lokace objednané služby (realizováno, přeskočeno…),</li><li>datum a čas potvrzení lokace objednané služby (časové razítko),</li><li>poloha potvrzení lokace objednané služby (místo vzniku),<br></li><li>…</li></ul><p>Poznámka: Přesná specifikace zprávy bude řešena až při detailním návrhu řešení. Struktura pak bude vycházet z již existujících typů zpráv.</p><p>Řešit musíme také spolehlivost komunikace, ta je zajištěna následovně (popsáno zjednodušeně):</p><ol><li>FOB odešle informaci o realizaci lokace objednané služby do RoadPlan (v předepsaném rozsahu, jedná se pak o zcela nový typ zprávy).</li><li>RoadPlan zprávu přijme a zpracuje. Současně odesílá potvrzení o přijetí zprávy zpět do FOB (tzv. ACK zpráva).</li><li>FOB čeká na přijetí potvrzující zprávy z RoadPlan:<br><ol><li>Pokud ACK zpráva přijde, tok událostí končí (odeslání informace z FOB do RP proběhlo úspěšně).</li><li>Jinak ACK zpráva v předepsaném intervalu nepřijde, dojde k jejímu opětovnému odeslání (přechod na krok 1).<br><ul><li>Na straně RP musí být podchycen případ, kdy přijde stejná zpráva vícekrát (opakovaná změna stavu realizace, problémy při komunikaci…).</li><li>V potaz je brána zpráva s nejnovějším datem události (zkoumaný čas odpovídá okamžiku provedení akce řidičem).</li><li>Při shodě je použita událost s vyšším identifikátorem paketu (případy, kdy je stejná zpráva odeslána vícekrát; každý paket má jedinečné ID).</li><li>V průběhu dne se tedy může na úrovni objednané služby měnit stav realizace (potvrzení / přeskočení).</li></ul></li></ol></li></ol><p>Poznámka: Zprávy jsou z FOB zasílány přímo do aplikace RoadPlan, informace tedy nejsou dostupné ve FWW2 (nevzniká tedy ani aktivace HW vstupu).</p><p>Nezbytnou součástí je logování komunikace s FOB. Ta aktuálně probíhá v tomto rozsahu:</p><ul><li> Logovány jsou všechny zprávy.</li></ul><p>Jedním z důvodů důležitosti logování komunikace je skutečnost, že ACK zpráva je z RP do FOB odeslána i v případě, kdy přečtení zprávy skončí chybou…</p><ul><li>Zpráva byla doručena, při jejím zpracování v RP však došlo k chybě. To ale není důvodem pro opětovné odeslání zprávy – její vyhodnocení typicky skončí stejnou chybou.</li><li>FOB tedy bere zprávu jako úspěšně odeslanou, v RP však došlo k chybě. Je tedy důležité mít informaci, proč k této chybě došlo (včetně četnosti obdobných situací v daném období)…</li><li>Výjimku mohou tvořit případy, kdy přijde zpráva z FOB poškozená. Taková situace však běžně nenastává, v první fázi tedy není nutné uvedený problém řešit.</li></ul><p>Poznámka: Stávající typ zprávy pro odeslání trasy denního výkonu do FOB nebude rozšířen o informaci se stavem realizace lokace objednané služby.</p><h3>Vyhodnocení realizace</h3><p>Zásadním krokem pro implementaci požadavku je úprava logiky, která zajišťuje vyhodnocení realizace denních výkonů. Zde budeme operovat na 2 základních úrovních…</p><ul><li><strong>Denní výkon</strong> – specifikace zdroje informací o realizaci včetně případných změn.</li><li><strong>Realizace denních výkonů</strong> – specifikaci použitých datových struktur včetně související logiky.</li></ul><h4>Vyhodnocení způsobu realizace na úrovni denního výkonu</h4><p>Způsob vyhodnocení realizace trasy vozidla v daný den je uveden na úrovni denního výkonu a může se měnit. Nemá pak žádný vliv na plánovanou trasu, svou roli hraje až při při zahájení realizace tohoto denního výkonu.</p><ul><li>Na úrovni denního výkonu je určen způsob vyhodnocení realizace objednaných služeb:<br><ul><li><strong>PTO</strong> – porovnání polohy aktivace sledovaného vstupu vzhledem k pozici jednotlivých lokací objednaných služeb (aktuální stav).</li><li><strong>FOB</strong> – přímé párování informací o realizaci dle jedinečného identifikátoru lokace objednané služby.</li></ul></li><li>Zdroj informací o realizaci je pak nastaven přímo na vozidle (použit při generování denních výkonů). Při jeho změně pak musí být provedeny následující akce:<br><ul><li>Pro denní výkony v minulosti není provedena žádná akce.</li><li>U denního výkonu s dnešním datem realizace je provedena změna hodnoty se zdrojem informací o realizaci. Následně dochází k přepočtu realizace objednaných služeb dle nově nastaveného zdroje (pokud již byla realizace zahájena).</li><li>Pro denní výkony v budoucnosti je změněn zdroj informací o realizaci.</li></ul></li></ul><p>Poznámka: Způsob vyhodnocení realizace objednaných služeb je pevně nastaven na úrovni vozidla. Minimálně v první fázi ho tedy není možné libovolně měnit u konkrétních denních výkonů. Využit je pak vždy <strong>právě</strong> 1 zdroj informací o realizaci.</p><h4>Způsob evidence informací o realizaci</h4><p>Informace o realizaci denního výkonu jsou získávány z externího zdroje…</p><ul><li>aktuálně se jedná výhradně o systém FLWW2 (aktivace vstupů),</li><li>nově budou získávány také z aplikace FOB (nový typ zprávy).</li></ul><p>V rámci jejich zpracování je pak potřeba specifikovat, jakým způsobem budou evidovány…</p><ul><li>aktuálně jsou aktivace vstupů ukládány bez vazby na odpovídající záznam o realizaci (dle získaných informací je aktualizován odpovídající záznam entity Obsluha lokace objednané služby),</li><li>u nového zdroje informací můžeme postupovat různými způsoby…<br><ul><li>využití stávající logiky (sdílení datových struktur bez dalších úprav, bez vazby zdrojových dat na záznam o realizaci),</li><li>vytvoření samostatného aparátu pro evidenci informací (nezávislý datový model),</li><li>kombinace uvedených přístupů (úprava stávajících datových struktur).</li></ul></li></ul><p>Jako vhodná se pak jeví kombinace uvedených přístupů. Využijeme tedy stávající logiku a vhodně ji rozšíříme. Věnovat se budeme také způsobu evidence zdrojových dat. Začneme pak stávajícím způsobem evidence informací o realizaci (entita Obsluha lokace objednané služby).</p><ul><li><p><strong>id</strong> – identifikátor záznamu.</p></li><li><p><strong>day_performance_realization_id</strong> – identifikátor odpovídající realizace denního výkonu.</p></li><li><p><strong>operation_date_time</strong> – datum a čas skutečné realizace lokace objednané služby.</p></li><li><strong>lat</strong>, <strong>lng</strong> – souřadnice, na kterých proběhla realizace lokace objednané služby.<br><ul><li>Poznámka: Aktuálně získávány z odpovídajícího pozičního záznamu.</li></ul></li><li><p><strong>ordered_service_location_id</strong> – identifikátor odpovídající lokace objednané služby.</p></li><li><strong>note</strong> – poznámka k realizaci lokace objednané služby.<br><ul><li>Poznámka: Aktuálně možné zadat pouze v apliakci RoadPlan.</li></ul></li><li><strong>is_visited</strong> – informace, zda byla lokace objednané služby realizována (0/1).<br><ul><li>Poznámka: Název atributu ne zcela odpovídá svému významu.</li></ul></li></ul><p>Poznámka: Záznam této tabulky vzniká pro všechny takové lokace objednané služby, u kterých je vyhodnocována realizace.</p><p>Pokud budeme chtít uvedenou strukturu využít, musíme ji vhodným způsobem rozšířit…</p><ul><li><strong>Zdroj informací</strong> – zdroj, ze kterého jsou získávány informace o realizaci (PTO, FOB).<br><ul><li>Informace nemusí být uložena přímo na této entitě, je možné ji získat také z odpovídajícího denního výkonu.</li><li>V takovém případě je ovšem nutné počítat se skutečností, že dispečer může na úrovni lokace objednané služby změnit odpovídající denní výkon (při potvrzení realizace denního výkonu).</li></ul></li><li><strong>Způsob odbavení</strong> – v aplikaci FOB je možné kromě potvrzení lokace provést i její přeskočení. Jako vhodné se tedy jeví přenesení informace také do RoadPlan…<br><ul><li>Bude mít vliv na obrazovku potvrzení realizace denního výkonu – odpovídající lokace bude pravděpodobně pouze graficky odlišena (barva, ikona…).</li><li>Co se týče funkčnosti, bude odpovídat stavu, kdy nebyla lokace objednané služby realizována (do budoucna možné rozšířit o informaci s důvodem přeskočení lokace).</li><li>Informace doplňuje stávající atribut <strong>is_visited</strong>, který říká, že byla daná lokace navštívena (přesněji realizována).<br><ul><li>Přidáváme tedy informaci, jaký byl výsledek této návštěvy – důvodem je možnost přeskočit lokaci, kdy navštívení nemusí znamenat potvrzení realizace.</li><li>Jedná se pak o doplňující informaci, která nebude mít zatím vliv na vyhodnocení realizace (bude pouze vhodně zobrazována).</li></ul></li></ul></li><li><strong>Identifikátor záznamu o realizaci</strong> –  identifikátor záznamu, dle kterého je vyhodnocována realizace v rámci dané lokace objednané služby.<br><ul><li>Nově budou přímo v RoadPlan evidovány s vazbou na záznam o realizaci jak aktivace vstupů z FLWW2, tak zprávy z FOB přímo v RoadPlan. Vyhodnocení, na jakou z entit identifikátor odkazuje, pak bude možné určit dle zdroje informací (viz dříve).</li><li>Poznámka: V rámci odkazované entity bude k dispozici mj. externí identifikátor, který nám umožní snazší řešení případných problémů (identifikátor záznamu ve FLWW2, identifikátor paketu zprávy z FOB).</li></ul></li></ul><p>Jak bylo naznačeno, za zvážení stojí rozšíření evidence zdrojových dat včetně vazby na záznam o realizaci (na úrovni informací z obou zdrojů – aktuálně PTO a FOB).</p><ul><li>Na straně FOB nejsou data o realizaci ukládána – po restartu zařízení již nejsou k dispozici. Jediným zdrojem je logování komunikace.</li><li>V případě komplikací tedy nebude možné odpovídající informace získat (na rozdíl od aktivací vstupů ve FLWW2).</li></ul><p>Poznámka: Možnost potvrzení realizace objednané služby mimo plán není v rámci návrhu uvažována (viz <a href="https://jira.radium.cz/browse/POP-1959">https://jira.radium.cz/browse/POP-1959</a>).</p><h4>Způsob vyhodnocení realizace</h4><p>Samotné vyhodnocení realizace aktuálně probíhá ve dvou krocích (velmi zjednodušeně):</p><ol><li>Systém získá informace o realizaci (aktuálně z FLWW2) a naplní odpovídající datovou strukturu.</li><li>Systém zobrazí informace o realizaci obsažené v této datové struktuře uživateli.</li></ol><p>Naším cílem pak je zachovat stávající logiku a pouze ji vhodně rozšířit. To sníží množství nutných změn v rámci implementace požadavku.</p><h5>Zahájení realizace denního výkonu</h5><p>Prvním krokem je zahájení realizace denních výkonů. To probíhá pouze pro schválené denní výkony a v daný den realizace. Dochází k němu dle jasně stanovených kritérií:</p><ul><li><strong>PTO</strong> <em>(aktuální stav)</em>: Systém čeká na získání takového pozičního záznamu z FLWW2, který splňuje stanovená kritéria. Po jeho přijetí je zahájena realizace odpovídajícího denního výkonu.<br><ul><li>Jedná se o poziční záznam se zapnutým motorem.</li><li>Jedná se o poziční záznam, který „existuje“. Ověřit: Význam zmíněné podmínky.</li><li>Ověřit: Úplnost uvedeného výčtu.</li></ul></li><li><strong>FOB</strong> <em>(nové chování)</em>: Při komunikaci s vozidlovým tabletem je realizace zahájena po přihlášení řidiče na trasu – přijetím prvního požadavku na stažení konkrétní části trasy (zpráva typu FOB_RT_PART_REQUEST).</li></ul><p>Po samotném zahájení realizace musíme nejprve připravit potřebnou datovou sktrukturu, v rámci které evidujeme informace o realizaci. Ověřit: Jsou záznamy vytvářeny již po schválení denního výkonu, nebo až po zahájení realizace?</p><ul><li><strong>Realizace denního výkonu</strong> <em>(tabulka day_performance_realization)</em>: Informace související s realizaci denního výkonu jako celku (začátek a konec realizace, ujetá vzdálenost, informace o potvrzení realizace…).</li><li><strong>Obsluha lokace objednané služby</strong> <em>(tabulka ordered_service_location_realization)</em>: Informace související s realizací konkrétní lokace objednané služby (datum a čas realizace, souřadnice provedení realizace…).</li></ul><p>Přímo evidovány jsou také informace o realizaci, pro každý zdroj je určena samostatná tabulka…</p><ul><li><strong>Pozice </strong><em>(tabulka day_performance_realization_position)</em>: poziční záznamy, dle kterých je např. vykreslena trajektorie daného vozidla (nejsou přímo využívány při potvrzení realizace objednaných služeb).<br><ul><li>Poznámka: Synchronizovány jsou pozice, které mají nastavenou hodnotu pro <strong>gpsDistance</strong>, které mají <strong>recordOrder</strong> větší nebo roven 0 a které obsahují validní souřadnice. Ověřit: Úplnost uvedeného výčtu.</li></ul></li><li><strong>Události </strong><em>(tabulka day_performance_realization_events)</em>: události generované jednotlivými vozidly, kdy některé z nich slouží k vyhodnocení realizace (nás zajímají aktivace definovaného HW vstupu).<ul><li>Poznámka: Synchronizovány jsou události, které mají validní souřadnice. Ověřit: Úplnost uvedeného výčtu.</li></ul></li><li><strong>Zprávy z FOB </strong><em>(nová tabulka)</em>: evidence informací o realizaci lokací objednaných služeb, které byly získány z vozidlového tabletu (možné přímo párovat s lokací v RoadPlan). K dispozici budou následující informace:<br><ul><li><strong>Identifikátor zprávy</strong> – identifikátor odpovídajícího paketu, ve kterém zpráva přišla (umožní párování záznamů s logováním komunikace).</li><li><strong>Identifikátor lokace</strong> – identifikátor lokace objednané služby, pro kterou byla odeslána zpráva (párování se záznamem v RoadPlan).</li><li><strong>Způsob odbavení</strong> – způsob, jakým byla odpovídající lokace objednané služby odbavena (potvrzení realizace, přeskočení).</li><li><strong>Datum a čas</strong> – časové razítko, ve kterém došlo k odbavení lokace objednané služby (provedení akce řidičem).</li><li><strong>Souřadnice</strong> – poloha místa, kde došlo k odbavení lokace objednané služby. (provedení akce řidičem).</li><li>Poznámka: Výsledná struktura se může v rámci detailního návrhu řešení ještě měnit. Zde jsou zmíněny především stěžejní informace nutné k vyhodnocení realizace.</li></ul></li></ul><p>Poznámka: Poziční data jsou v obou případech načítána z FLWW2 (vykreslení trajektorie apod.), my zde řešíme především potvrzování realizace jednotlivých objednaných služeb (resp. jejich lokací).</p><h5>Vyhodnocení realizace denního výkonu</h5><p>Když máme připravenou datovou strukturu, můžeme začít vyhodnocovat na vstupu získaná data. Prvním krokem je jejich získání – naplnění tabulek se zdrojovými daty.</p><ul><li><strong>PTO</strong>: Informace jsou získány synchronizací pozičních záznamů z FLWW2 (pozice, události), které probíhá v intervalu 1 minuty.</li><li><strong>FOB</strong>: Informace jsou získány ve formě zprávy odeslané aplikací FOB, které je provedeno ihned po interakci řidiče.</li></ul><p>Dalším krokem je zpracování získaných dat a jejich vyhodnocení v rámci odpovídajících denních výkonů. I přesto, že jsou data z FOB získávána okamžitě po jejich vytvoření (interakce řidiče), budeme dále pracovat v definovaném intervalu (aktuálně 1 minuta). Důvody pro toto rozhodnutí jsou následující:</p><ul><li>Pokud přijdou čerstvé informace z FOB, nemusí být ještě k dispozici odpovídající poziční záznamy.</li><li>To znamená, že by sice uživatel viděl informace o realizaci, ale „nevedla“ by k nim trajektorie vozidla.</li><li>Dalším důvodem je sjednocení výsledného chování – vyhodnocení realizace bude probíhat souběžně.</li></ul><p>Samotné vyhodnocení realizace je pak řešeno na úrovni jednotlivých denních výkonů, probíhá následovně… Ověřit: Úplnost uvedeného výčtu.</p><ol><li>Pro denní výkon jsou načteny nově získané informace o realizaci (z tabulek se zdrojovými daty).<br><ul><li>Zdroj dat odpovídá způsobu vyhodnocení realizace v rámci denního výkonu (události z FLWW2 / zprávy z FOB).</li><li>Zajímají nás pak záznamy s posledním změnou provedenou od poslední synchronizace.<br><ul><li>Ověřit: Časové okno je pravděpodobně rozšířeno (důvodem v minulosti řešené problémy). Děje se tak pouze při synchronizaci, nebo také při vyhodnocení realizace?</li></ul></li></ul></li><li>Následně jsou získané informace vyhodnoceny – probíhá jejich párování na záznamy entity <strong>Obsluha lokace objednané služby</strong>.<br><ul><li><strong>PTO</strong>: Vyhodnocení probíhá porovnáním polohy události s polohou lokací obsažených v rámci denního výkonu (včetně pořadí lokace v rámci denního výkonu, viz obrázek na začátku dokumentu).</li><li><strong>FOB</strong>: Vyhodnocení probíhá přímým párováním zprávy a konkrétní lokace objednané služby (dle jedinečného identifikátoru). Je pak nutné počítat se situací, kdy má řidič načtenou původní (neaktuální) trasu, ale objednaná služba je již naplánována na jiné vozidlo → v takovém případě nedochází k označení dané lokace jako realizované (rozhodující je stav objednané služby v DB aplikace RoadPlan v čase vyhodnocení realizace – její přiřazení k dennímu výkonu).<br></li><li>V obou případech je řešeno vyhodnocení, zda byla lokace objednané služby obsloužena ve stanoveném pořadí (na UI označeno červeným podbarvením).<br><ul><li>Ověřit: Je tato informace uložena v DB, nebo se vyhodnocuje při každém zobrazení?</li></ul></li></ul></li></ol><p>Plnění struktury s <strong>Obsluhami lokací objednaných služeb</strong> se pak odvíjí dle zdroje informací o realizaci. Samotné chování je ve zjednodušené podobě naznačeno v tabulce…</p><table><tbody><tr><th>Atribut řešené entity</th><th>Událost z FLWW2</th><th>Zpráva z FOB</th><th>Poznámka</th></tr><tr><td>Identifikátor záznamu</td><td>– </td><td>–</td><td>Generováno při založení nového záznamu.</td></tr><tr><td colspan="1">Identifikátor odpovídající lokace objednané služby</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Nastaveno dle lokace objednané služby, pro kterou odpovídající záznam vznikl.</td></tr><tr><td colspan="1">Identifikátor odpovídající realizace denního výkonu</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Nastaveno dle přiřazení odpovídající objednané služby k realizaci denního výkonu.</td></tr><tr><td colspan="1">Zdroj informací o realizaci</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Nastaveno dle odpovídajícího vozidla (definice zdroje informací o realizaci).</td></tr><tr><td colspan="1">Identifikátor záznamu o realizaci</td><td colspan="1">Identifikátor odpovídajícího záznamu tabulky <strong>day_performance_realization_events</strong>.</td><td colspan="1">Identifikátor odpovídajícího záznamu nové tabulky (zprávy z FOB).</td><td colspan="1">Tabulka, které odpovídá nastavený identifikátor, je vyhodnocena dle nastaveného zdroje informací o realizaci.</td></tr><tr><td colspan="1">Datum a čas realizace</td><td colspan="1">Atribut <strong>datetime</strong>.</td><td colspan="1">Čas provedení akce ve FOB.</td><td colspan="1">–</td></tr><tr><td colspan="1">Souřadnice realizace</td><td colspan="1">Atributy <strong>lat</strong>, <strong>lng</strong>.</td><td colspan="1">Souřadnice, na kterých byla provedena akce ve FOB.</td><td colspan="1">–</td></tr><tr><td colspan="1">Poznámka</td><td colspan="1">–</td><td colspan="1"><em>V první fázi není řešeno.</em></td><td colspan="1">Informaci je možné nastavit přímo v aplikaci RoadPlan.</td></tr><tr><td colspan="1">Byla realizována</td><td colspan="1">Pokud došlo k potvrzení realizace (napárování na událost z FLWW2) je nastavena hodnota <strong>TRUE</strong> (jinak <strong>FALSE</strong>).</td><td colspan="1">Pokud byla získána zpráva s odpovídajícím identifikátorem lokace, ve které došlo k potvrzení realizace, je nestavena hodnota <strong>TRUE</strong> (jinak <strong>FALSE</strong>).</td><td colspan="1">Zpráva z FOB může také obsahovat informaci o přeskočení dané lokace.</td></tr><tr><td colspan="1">Způsob odbavení</td><td colspan="1">Hodnota není vyplňována.</td><td colspan="1">Způsob odbavení ve FOB (potvrzení, přeskočení).</td><td colspan="1"><div>Nejedná se o povinný údaj.</div></td></tr></tbody></table><p>Jakmile začneme zpracovávat data o realizaci, můžeme provést také jejich zobrazení v aplikaci (obrazovka monitoringu realizace). Zobrazujeme pak aktuální stav realizace schválených denních výkonů. Staří uvedeného pohledu by nemělo přesáhnout jednu minutu. Mohou však nastat situace, kdy je třeba informace o realizaci přepočítat. Děje se tak především v těchto případech:</p><ul><li><strong>Operativní změny</strong>– denní výkon je možné modifikovat ještě v den realizace. Při změně plánované trasy pak dochází také ke kompletnímu přepočtu informací o realizaci (zachována jen zdrojová data).<ul><li>Ověřit: Dochází k přepočtu realizace celého denního výkonu, nebo pouze v rámci provedených změn (objednaných služeb).</li></ul></li><li><strong>Změna zdroje informací</strong> – pokud je vozidlo osazeno tabletem, dochází ke změně nastavení jeho zdroje informací o realizaci. To způsobí kompletní přepočet informací o realizaci – dle jiného zdroje dat (jen pro právě plněné denní výkony).</li></ul><h5>Potvrzení realizace denního výkonu</h5><p>Díky zachování datové struktury (došlo pouze k rozšíření) můžeme využít stávající aparát pro potvrzení realizace denních výkonů (potvrzení realizace probíhá na úrovni objednané služby).</p><p>Poznámka: Provedené změny mohou mít vliv na uživatelské rozhraní, mělo by se však jednat především o zobrazení nově získaných informací.</p><h3>Uživatelské rozhraní</h3><p>Informace o zdroji dat pro potvrzení realizace by měla být viditelná také v aplikaci. Zobrazit ji můžeme jak na úrovni vozidla (jeho aktuální nastavení), tak pro odpovídající denní výkony (způsob vyhodnocení v daný den).</p><p>Poznámka: Aktuálně není přehled vozidel k dispozici, informaci tedy zobrazujeme pouze na úrovni denního výkonu.</p><h4>Přehled denních výkonů</h4><p>Tabulka přehledu denních výkonů je doplněna o nový sloupec s informací se zdrojem dat pro potvrzení realizace. Hodnota je pak zobrazena ve formě textu, dostupný je výčtový filtr.</p><p>Poznámka: Současně můžeme informaci doplnit také v panelu s detailními informacemi, také ve formě prostého textu. </p><h4>Plánování denních výkonů</h4><p>Obrazovka plánování je doplněna o ikonu naznačující zdroj dat pro potvrzení realizace, k dispozici je pak samozřejmě také kontextová nabídka s významem (použité ikony jsou pouze ilustrativní).</p><p>Poznámka: Důležitost informace na obrazovce editace denního výkonu je na zvážení, proto není součástí tohoto návrhu řešení (zatím nebude realizováno).</p><p><img src="id-084-prime-vyhodnoceni-realizace-objednane-sluzby-dle-informaci-z-tabletu-114460676_images/image2023-4-27 14-31-18.png" data-attachment="true"></p><h4>Realizace denních výkonů</h4><p>Obrazovka monitoringu realizace je doplněna o informaci se zdrojem dat pro potvrzení realizace. Došlo pak k rozšíření kontextové nabídky realizace denního výkonu (zobrazené hodnoty jsou pouze ilustrativní). Důvodem je především to, že způsob potvrzení realizace je jasně patrný přímo z mapy (viz dále).</p><p>Poznámka: Důležitost informace na obrazovce potvrzení realizace denního výkonu je na zvážení, proto není součástí tohoto návrhu řešení (zatím nebude realizováno).</p><p><img src="id-084-prime-vyhodnoceni-realizace-objednane-sluzby-dle-informaci-z-tabletu-114460676_images/image2023-4-27 14-43-11.png" data-attachment="true"></p><h4>Zobrazení v mapě</h4><p>V mapách, které zobrazují denní výkony, typicky vidíme plánovanou a skutečnou trasu vozidla pro daný den. V rámci té skutečné navíc vidíme místa, ve kterých došlo k manipulaci s nádobou. U vozidel s potvrzováním realizace pomocí tabletu je však poloha aktivace vstupu nahrazena informací z tabletu. Je tedy vhodné uvedené události graficky odlišit (použitá ikona je pouze ilustrativní).</p><p>Budoucí rozvoj: Jako vhodné rozšíření se jeví „grafické párování“ lokace objednané služby s odpovídajícím záznamem o realizaci. Uživatel by po výběru lokace viděl, který záznam potvrdil její realizaci (a naopak). Mohl by tak snadno vyhodnotit, zda poloha lokace objednané služby odpovídá poloze potvrzení realizace (kontrola dispečerem – zda řidič potvrzuje realizaci v místě lokace, nebo až později např. v rámci povinné přestávky). Doplněna by mohla být také indikace „podezřelých“ realizací (velká vzdálenost mezi polohou lokace a její realizace). Současně by to dispečerovi pomohlo párovat dvojice v rámci frekventovaných stanovišť.</p><p>Poznámka: Požadavek na současné zobrazení aktivace vstupu a místa, kde došlo k potvrzení realizace v tabletu, není součástí tohoto návrhu řešení (viz <a href="#" data-page-title="ID-083: Zobrazení informace o práci čerpadla na obrazovce monitoringu realizace"></a>).</p><p><img src="id-084-prime-vyhodnoceni-realizace-objednane-sluzby-dle-informaci-z-tabletu-114460676_images/image2023-4-27 13-44-3.png" data-attachment="true"></p><h2>Aplikace FOB</h2><p>Na všechny body v trase, které se potvrzují posádkou (kromě Přestávky) se pošle vždy informační zpráva do RP.</p><p>FOB již <strong>nebude</strong> aktivovat SW vstup ve vozidlové jednotce (IN5, případně IN10).</p><p><strong>Ideální stav je takový, že daná zpráva se ihned po potvrzení obsluhou úspěšně odešle a bod se následně v krátkém čase označí v RP.</strong></p><p>Avšak mohou nastat situace, kdy není dostupná komunikace na server (není GSM apod.), z toho důvodu si bude aplikace FOB ukládat všechny tyto zprávy a dle potřeby je bude zkoušet pravidelně opětovně odesílat.</p><h3>Funkcionalita FOB</h3><ul><li>pokusy o opětovné odesílání zprávy budou probíhat pouze v případě aktivního GSM spojení,</li><li>FOB se bude pokoušet tyto zprávy odesílat v pravidelných zvyšujících se intervalech, dokud neobdrží potvrzení o doručení, </li><li>jakmile by se dostala další nová zpráva do fronty pro odesílání, interval odesílání se opět sníží na počáteční úroveň a takto se to bude neustále opakovat,</li><li>zprávy k aktuální dnešní trase se budou odesílat jen dnešní den, kdyby se v krajní situaci stalo, že např. za včerejší den není vše odesláno, tak aplikace se již následující den nebude pokoušet odesílat tyto staré zprávy (RP stejně by již se staršími body nepracoval),</li><li>neodeslané zprávy si FOB bude pamatovat i po svém restartu v rámci aktuálního dne, po znovu najetí aplikaci v rámci aktuální dne, budou opětovně zahájeny pokusy o odesílání zpráv.</li></ul><h3>Fungování v aplikaci FOB</h3><ul><li>uživatel nebude nijak omezen, např. že by mu nebyla dovolena další práce, když ještě nebude zpráva o realizaci úspěšně doručena na server,</li><li>na dané dlaždici bodu, na který se odesílá potvrzení bude příznakem(vhodnou decentní animací) zobrazen stav odesílání informace potvrzení (bude součástí grafického návrhu),</li><li>odesílání potvrzení nebude možné vyvolat obsluhou ručně, pro opětovný pokus o odeslání potvrzení se bude plně automaticky starat FOB.</li></ul><h4>LOG:</h4><ul><li>FOB bude obsahovat v záložce Systém komunikační log k jednotlivým bodům, kde by bylo případně vidět, kdy a na jaký bod přišlo potvrzení, případně zalogovaný error stav apod.</li><li>záznamy v logu budou podle ID jednotlivých bodů, ID bodu bude zobrazeno nově v detailu každého bodu</li><li>aktivní log bude vždy, když se bude řešit odesílání této nové zprávy + navíc se zalogují i další zprávy z modulu Trasy</li><li>log bude připraven na budoucí přidání i jiných zpráv používaných v aplikaci</li></ul><p><br></p><p>Komunikace s RP</p><p>Aby bylo do RP možné poslat všechny potřebné informace o realizaci objednané služby, musíme rozšířit komunikační protokol o nový typ zprávy (XML Packet).</p><ul><li>zpráva bude potvrzovaná, bude zaručeno, že RP zprávu vždy potvrdí, i kdyby se jednalo o duplicitní (již tu samou v minulosti obdržel),</li><li>při změně v trase, např. při odmazání a přidání bodu se NIKDY nesmí stát, že v rámci jedné trasy za konkrétní den, by se použilo ID bodu, které bylo již jednou v té trase,</li><li>FOB bude brát validní odpověď na zprávu i třeba error, prostě jakákoli odpověď na zprávu se bere jako validní (např. RP vrátí chybu že trasu nezná, nebo něco se v RP rozbije apod.),</li><li>FOB standardně pošle packet s packet_id, RP s tím to packet_id odpoví, aby bylo možné jednoznačně potvrzení(příchozí zprávu) na straně FOBu identifikovat,</li><li>RP musí počítat s tím, že k jednomu bodu může přijít více zpráv, ale ne v pořadí, tak jak byly realizované, RP se musí řídit podle času v packetu a vyhrát by měl ten nejnovější čas (nejnovější stav),</li><li>jestliže se budou odesílat zprávy na body včerejší a starší, tak RP musí tyto starší body správně vyhodnocovat,</li><li>jestliže budeme posílat více stavů k jednomu bodu, RP to musí správně vyhodnocovat.<br><br></li></ul><h4>Obsah nového packetu:</h4><ul><li>identifikátor trasy (route_id),</li><li>identifikátor lokace objednané služby (párování informací z FOB a RP),</li><li>stav realizace lokace objednané služby - realizováno<strong> (aktuálně se řeší pouze odesílání stavu "realizováno")</strong></li><li>datum a čas potvrzení lokace objednané služby (časové razítko) v UTC</li><li>GPS poloha potvrzení lokace objednané služby (místo vzniku).</li></ul><p><br></p><h4>Rizika</h4><ul><li>při dlouhodobém výpadku komunikace, nebo serveru apod. se ve výjimečných situacích nemusí pro aktuální den doručit zpráva o odbavení bodu do RP </li></ul><p><br></p><h4>Grafický návrh</h4><ul><li>pro tento úkol bude vyhotoven grafický návrh<br><h4><br></h4></li></ul><h3>Možné budoucí rozvoje aplikace</h3><ul><li>nastavení odesílacích period a pokusů v aplikaci nebo v konfiguračních souborech </li><li>odesílání i dalších stavů jako "není odbaveno, vyřazeno, zařazeno"</li></ul><h1>Akceptační testy</h1><p>Pro splnění požadavku musí být splněny následující testovací scénáře.</p><h2>TC01: Xxx</h2><ol><li>Systém…</li></ol><h1>Poznámka</h1><p>–</p>
</div>
</body>
</html>

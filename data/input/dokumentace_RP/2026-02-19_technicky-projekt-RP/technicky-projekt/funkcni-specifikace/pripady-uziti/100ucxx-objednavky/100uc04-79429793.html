<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>100UC04: Uzavřít objednávku</title>
</head>
<body>
<div class="wiki-content">
<p></p><h1>Stručný popis, cíl UC</h1><p>Uzavřením Objednávky je deklarováno kompletní vyřízení požadavků Objednatele. Z pohledu systému RoadPlan není potřebné žádné další zpracování takto uzavřených Objednávek. </p><p>Uzavírat lze jen Objednávky, které jsou v určitém stavu. Odpovídající Objednané služby, pokud nejsou označeny jako realizované či zrušené, jsou systémem zrušeny.</p><p>Samotné uzavření Objednávky je vykonáno buď manuální akcí Uživatele, nebo automaticky systémem RoadPlan – pravidelně spouštěnou úlohou.</p><p>Poznámka: Po uzavření objednávky již dále nedochází ke generování objednaných služeb dle pravidla opakování s neomezenou délkou trvání.</p><h1>Seznam aktérů</h1><table><tbody><tr><th>Aktér</th><th>Popis</th><th colspan="1">Typická role</th></tr><tr><td>Uživatel</td><td><p>Jedná se o uživatele aplikace RoadPlan, který musí mít oprávnění spouštět tento UC.</p></td><td colspan="1"><p>Příjem objednávek</p></td></tr><tr><td colspan="1">Čas</td><td colspan="1">Komponenta systému RoadPlan, která dle nastavených parametrů spouští v požadovaném čase danou úlohu.</td><td colspan="1">-</td></tr></tbody></table><h1>Spuštění případu užití</h1><p>V případě manuálního uzavření Objednávky je bodem spuštění <a href="#" data-page-title="100UC05: Zobrazit přehled objednávek"></a>. Zde Uživatel vybere Objednávku a zadá požadavek k jejímu uzavření.</p><p>UC je také spouštěn automaticky Systémem v předem definovaných časových intervalech (viz <a href="../../../konfiguracni-81592468.html">autoCloseOrdersSchedule</a>).</p><h1>Vstupní podmínky</h1><ul><li>Objednávka je v jednom z uvedených <a href="../../../high-level-concept/stavove-78680652.html">stavů</a> (atribut stav): Plněná, K realizaci.</li><li>Pouze pro manuální uzavírání:<br><ul><li>Uživatel je přihlášený a má oprávněný modifikovat Objednávky (viz <a href="../../../uzivatelska-78681297.html">Práva a role</a>).</li><li>Na vstupu je předána identifikace vybrané Objednávky.</li><li>Dále může být vyhodnocováno oprávnění na modifikaci Denních výkonů (viz <a href="../../../uzivatelska-78681297.html">Práva a role</a>).</li><li>Dále může být vyhodnocováno oprávnění na modifikaci Objednaných služeb (viz <a href="../../../uzivatelska-78681297.html">Práva a role</a>).<br></li></ul></li></ul><p><em>Poznámka: Při nesplnění vstupních podmínek systém nenabízí v nástrojové liště tlačítko pro uzavření. Tato kompetence náleží do nadřazeného UC.</em></p><h1>Základní tok událostí - manuální uzavření Objednávky</h1><ol><li>Pokud na vstupu získaná Objednávka obsahuje alespoň jednu Objednanou službu ve stavu Ke kontrole:<br><ol><li>Přechod na <a href="100uc04-79429793.html">EF02: Stav Objednaných služeb neumožňuje uzavření</a>.</li></ol></li><li>Pokud na vstupu získaná Objednávka obsahuje alespoň jednu Objednanou službu ve stavu Naplánovaná a zároveň uživatel nemá oprávnění na modifikaci Denních výkonů:<br><ol><li>Přechod na <a href="100uc04-79429793.html">EF04: Uživatel nemá oprávnění na odebrání objednaných služeb z denních výkonů</a>.</li></ol></li><li>Pokud na vstupu získaná Objednávka obsahuje alespoň jednu Objednanou službu ve stavu K naplánování a zároveň uživatel nemá oprávnění na modifikaci Objednaných služeb:<br><ol><li>Přechod na <a href="100uc04-79429793.html">EF05: Uživatel nemá oprávnění na zrušení objednaných služeb</a>.</li></ol></li><li>Pokud na vstupu získaná Objednávka obsahuje alespoň jednu Objednanou službu ve stavu Naplánovaná, která je zároveň vložena na Denní výkon ve stavu Plněný:<br><ol><li>Přechod na <a href="100uc04-79429793.html">EF06: Stav odpovídajících denních výkonů neumožňuje uzavření</a>.</li></ol></li><li>Systém zobrazí potvrzovací dialog s dotazem na uzavření Objednávky (MSG_CONF_CLOSE_ORDER, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Uživatel svůj požadavek potvrdí (<a href="100uc04-79429793.html">EF01: Stav Objednávky neumožňuje uzavření</a>).</li><li>Systém Objednávku přepne do stavu "Uzavřená".</li><li>Systém zavře potvrzovací dialog.</li><li>Konec UC.</li></ol><h1>Základní tok událostí - automatické uzavírání Objednávek</h1><ol><li>Systém pro každou Objednávku, která splňuje vstupní podmínky:<br><ol><li>Ověří, zda Objednávka obsahuje Objednaný úkon, který má podmínku vykonání = "Výzva".<br><ol><li>Pokud takový úkon obsahuje, pak systém tuto Objednávku neuzavře a pokračuje na další Objednávku.</li></ol></li><li>Zkontroluje, zda pro Objednávku byly vygenerovány všechny Objednané služby a zda jsou v odpovídajícím stavu (viz <a href="100uc04-79429793.html">Validace: Kontrola úplnosti a stavu Objednaných služeb</a>).<br><ol><li>Pokud je výsledek kontroly pozitivní, systém Objednávku přepne do stavu "Uzavřená".</li><li>Jinak systém tuto Objednávku neuzavře.</li></ol></li></ol></li></ol><h1>Alternativní toky událostí</h1><h3>AF01: Stav Objednaných služeb vyžaduje jejich zrušení</h3><h4>Vstupní podmínky</h4><ul><li>Na vstupu získaná Objednávka obsahuje alespoň jednu Objednanou službu v jednom z uvedených stavů: K naplánování, Naplánovaná.</li></ul><h4>Tok událostí</h4><ol><li>Alternativní tok událostí začíná krokem 5 základního toku událostí při manuálním uzavření Objednávky (viz <a href="100uc04-79429793.html">Základní tok událostí - manuální uzavření Objednávky</a>).</li><li>Systém zobrazí potvrzovací dialog s dotazem na uzavření Objednávky a zrušení odpovídajících Objednaných služeb (kód hlášky MSG_CONF_CLOSE_ORDER_CANCEL_ORDER_SERVICES, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Uživatel svůj požadavek potvrdí (<a href="100uc04-79429793.html">EF01: Stav Objednávky neumožňuje uzavření</a>).</li><li>Pro všechny Objednané služby na vstupu získané Objednávky, které jsou ve stavu Naplánovaná:<br><ol><li>Systém spustí <a href="#" data-page-title="200UC26: Odebrat položky z denního výkonu"></a>, na vstup jsou předány následující hodnoty (<a href="100uc04-79429793.html">EF03: Uzavření objednávky neproběhlo v pořádku</a>):<br><ul><li>Položka denního výkonu: atribut Položka denního výkonu odpovídající Objednané služby.</li></ul></li></ol></li><li>Pro všechny Objednané služby na vstupu získané Objednávky, které jsou ve stavu K naplánovaná (zahrnuje i Objednané služby z kroku 4):<br><ol><li>Systém spustí <a href="#" data-page-title="101UC05: Zrušit objednanou službu"></a>, na vstup jsou předány následující hodnoty (<a href="100uc04-79429793.html">EF03: Uzavření objednávky neproběhlo v pořádku</a>):<br><ul><li>Objednaná služba: odpovídající Objednaná služba.</li></ul></li></ol></li><li>Systém Objednávku přepne do stavu "Uzavřená".</li><li>Systém zavře potvrzovací dialog.</li><li>Návrat na krok 9 základního toku událostí při manuálním uzavření Objednávky (viz <a href="100uc04-79429793.html">Základní tok událostí - manuální uzavření Objednávky</a>).</li></ol><h4>Výstupní podmínky</h4><ul><li>Objednané služby odpovídající objednávky splňují kritéria na jejich úplnost a stav. Tato Objednávka je přepnuta do stavu "Uzavřená".</li></ul><h1>Výjimkové toky událostí</h1><h3>EF01: Stav Objednávky neumožňuje její uzavření</h3><ol><li>Systém zobrazí uživateli informaci o stavu Objednávky, který neumožňuje její uzavření (MSG_ERR_UNABLE_CLOSE_ORDER_STATE, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Systém ukončí UC.</li></ol><p><em>Poznámka: Tento EF může nastat v případě, kdy front-end systému umožnil spuštění UC, ale mezitím došlo (např. akcí jiného Uživatele) ke změně stavu Objednávky tak, že její uzavření už možné není.</em></p><h3>EF02: Stav Objednaných služeb neumožňuje uzavření</h3><ol><li>Systém zobrazí uživateli informaci, že před uzavřením Objednávky musí být všechny Objednané služby realizovány nebo zrušeny (MSG_ERR_UNABLE_CLOSE_ORDER_SERVICES, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Systém ukončí UC.</li></ol><p><em>Poznámka: Uživatel se v takovém případě musí nejdříve postarat o příslušné Objednané služby. Tj. potvrdit realizaci odpovídajících denních výkonů a dostat je do stavu, kdy mají potvrzenou realizaci, nebo je zrušit.</em></p><h3>EF03: Uzavření objednávky neproběhlo v pořádku</h3><ol><li>Systém zobrazí uživateli informaci, že uzavření Objednávky neproběhlo v pořádku (MSG_ERR_UNABLE_CLOSE_ORDER_ERROR, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Systém ukončí UC.</li></ol><p><em>Poznámka: Tento EF může nastat v případě, kdy některý z volaných UC skončí chybou (např. odebírání Objednaných služeb z Denních výkonů).</em></p><h3>EF04: Uživatel nemá oprávnění na odebrání objednaných služeb z denních výkonů</h3><ol><li>Systém zobrazí uživateli informaci, že uživatel nemá oprávnění na odebrání Objednaných služeb z Denních výkonů (MSG_ERR_UNABLE_CLOSE_ORDER_DAILY_ROUTES_UNAUTHORIZED_ACCESS, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Systém ukončí UC.</li></ol><p><em>Poznámka: Aby bylo možné uzavřít Objednávku, která obsahuje Objednané služby naplánované na Denní výkon, je nutné oprávnění k modifikaci Denních výkonů.</em></p><h3>EF05: Uživatel nemá oprávnění na zrušení objednaných služeb</h3><ol><li>Systém zobrazí uživateli informaci, že uživatel nemá oprávnění ke zrušení Objednaných služeb (MSG_ERR_UNABLE_CLOSE_ORDER_ORDER_SERVICES_UNAUTHORIZED_ACCESS, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Systém ukončí UC.</li></ol><p><em>Poznámka: Aby bylo možné uzavřít Objednávku, která obsahuje zatím nenaplánované Objednané služby, je nutné oprávnění k modifikaci Objednaných služeb.</em></p><h3>EF06: Stav odpovídajících denních výkonů neumožňuje uzavření</h3><ol><li>Systém zobrazí uživateli informaci, že před uzavřením Objednávky musí být všechny Objednané služby naplánované na právě plněné Denní výkony nejprve z těchto Denních výkonů odebrány (MSG_ERR_UNABLE_CLOSE_ORDER_DAILY_ROUTES_ARE_JUST_REALIZED, viz <a href="../../../systemove-78681299.html">Systémové hlášky</a>).</li><li>Systém ukončí UC.</li></ol><p><em>Poznámka: Aby bylo možné uzavřít Objednávku, která obsahuje Objednané služby naplánované na Denní výkony ve stavu Plněný, je nutné tyto Objednané služby z Denních výkonů nejprve ručně odebrat.</em></p><h1>Výstupní podmínky</h1><p>Objednávka předaná na vstupu je přepnuta do stavu "Uzavřená".</p><h1>Validace</h1><h3>Kontrola úplnosti a stavu Objednaných služeb</h3><p>Kontrola má pozitivní výsledek, pokud současně platí:</p><ul><li>Pro danou Objednávku již byly vygenerovány všechny Objednané služby.<br><ul><li>Týká se případu, kdy je v Pravidlu opakování nastavena <a href="../101ucxx-objednane-sluzby/101uc01-82116734.html">neomezená délka období</a>.</li></ul></li><li>Všechny Objednané služby jsou v jednom ze stavů {Realizovaná, Nezrealizovaná, Zrušená}.</li></ul><h1>Algoritmy</h1><p>Nejsou.</p><h1>Uživatelské rozhraní</h1><p>Standardní potvrzovací dialog. Text hlášky, tlačítka a titulek dialogu specifikovány v přehledu <a href="../../../systemove-78681299.html">Systémové hlášky</a>, na který se odkazují jednotlivé toky událostí tohoto UC.</p><h1>Revize</h1><h3>25. 8. 2020: Tomáš Nadrchal,</h3><table><tbody><tr><th>Odkaz</div></div></th><th>Stručný popis změny/doplnění</div></div></th></tr><tr><td colspan="1"><a href="100uc04-79429793.html">Základní tok událostí - manuální uzavření Objednávky</a></td><td colspan="1">Doplněno vyhodnocení naplánovaných objednaných služeb, opraveno volání UC (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">EF05: Uživatel nemá oprávnění na zrušení objednaných služeb</a></td><td colspan="1">Opraven překlep v textu chybového hlášení (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">EF06: Stav odpovídajících denních výkonů neumožňuje uzavření</a></td><td colspan="1">Doplněn EF pro případ, kdy jsou některé objednané služby naplánovány na denní výkon, který je ve stavu Plněný (naznačeno modře).</td></tr></tbody></table><h3>14. 7. 2020: Tomáš Nadrchal</h3><table><tbody><tr><th>Odkaz</div></div></th><th>Stručný popis změny/doplnění</div></div></th></tr><tr><td colspan="1"><a href="100uc04-79429793.html">Stručný popis, cíl UC</a></td><td colspan="1">Upřesněn stručný popis UC (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">Vstupní podmínky</a></td><td colspan="1">Doplněno oprávnění na modifikaci denních výkonů (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">AF01: Stav Objednaných služeb vyžaduje jejich zrušení</a></td><td colspan="1">Doplněn AF pro případ, kdy je potřeba zrušit objednané služby obsažené v rámci objednávky (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">EF02: Stav Objednaných služeb neumožňuje uzavření</a></td><td colspan="1">Aktualizována poznámka k EF (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">EF03: Uzavření objednávky neproběhlo v pořádku</a></td><td colspan="1">Doplněn EF pro případ, kdy dojde v rámci volaných UC k chybě (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">EF04: Uživatel nemá oprávnění na odebrání objednaných služeb z denních výkonů</a></td><td colspan="1">Doplněn EF pro případ, kdy jsou některé objednané služby naplánovány na denní výkon, ale uživatel nemá oprávnění editovat denní výkony (naznačeno modře).</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">EF05: Uživatel nemá oprávnění na zrušení objednaných služeb</a></td><td colspan="1">Doplněn EF pro případ, kdy existují zatím nenaplánované objednané služby, ale uživatel nemá oprávnění editovat objednané služby (naznačeno modře).</td></tr></tbody></table><h3>11. 7. 2019: Miroslav Slivoně</h3><table><tbody><tr><th>Odkaz</div></div></th><th>Stručný popis změny/doplnění</div></div></th></tr><tr><td colspan="1"><a href="100uc04-79429793.html">Vstupní podmínky</a></td><td colspan="1">Rozšířeno o stav K realizaci.</td></tr><tr><td colspan="1"><a href="100uc04-79429793.html">Kontrola úplnosti a stavu Objednaných služeb</a></td><td colspan="1">Rozšířeno o nový stav Nezrealizovaná.</td></tr></tbody></table>
</div>
</body>
</html>

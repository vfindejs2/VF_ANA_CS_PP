<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>600UC01: Import dat z WinyX</title>
</head>
<body>
<div class="wiki-content">
<p></p><h1>Stručný popis, cíl UC</h1><p>UC zpracovává data, která jsou z externího systému (WinyX) zapsána na databázové rozhraní. Jedná se o data o Zákaznících, Likvidačních místech, Provozovnách a o některé číselníkové hodnoty.</p><p>Na základě těchto dat systém RoadPlan provádí synchronizaci záznamů o příslušných entitách ve své databázi - tj. vytváří nové záznamy, upravuje údaje stávajících záznamů, nebo záznamy označuje za smazané.</p><p>Konkrétní struktura dat k importu je uvedená v <a href="../../../high-level-concept/integrace-78680671.html">Definici rozhraní</a> (na listu WinyX → RoadPlan).</p><p>Poznámka: Při načítání <a href="../../../datove-modely/datovy-78681044.html">Zákazníků</a>, pokud by byla na rozhraní dostupná položka <a href="../../../datove-modely/datovy-78681044.html">Právní forma</a>, může dojít k situaci, kdy načtená <a href="../../../datove-modely/datovy-78681044.html">Právní forma</a> nebude obsažena v rámci systému. Nebude tedy dostupná instance odpovídající <a href="../../../datove-modely/datovy-78681044.html">Právní formy</a>. V takovém případě by došlo k vyplnění systémové <a href="../../../datove-modely/datovy-78681044.html">Právní formy</a>: Nenalezeno. Nyní tato situace nastat nemůže, ale do budoucna je s tím potřeba počítat.</p><h1>Seznam aktérů</h1><table><tbody><tr><th>Aktér</th><th>Popis</th><th colspan="1">Typická role</th></tr><tr><td>Čas</td><td><p>Komponenta systému, která spouští dávkové úlohy ve stanoveném čase.</p></td><td colspan="1"><p>-</p></td></tr></tbody></table><h1>Spuštění případu užití</h1><p>UC je spouštěn podle definovaného časového harmonogramu (viz <a href="#" data-page-title="Konfigurační hodnoty"></a>) automaticky.</p><h1>Vstupní podmínky</h1><p>Je dostupné (databázové) rozhraní pro synchronizaci údajů (<a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-EF02:Nedostupnédatabázovérozhraní">EF02:Nedostupné DB rozhraní</a>).</p><h1>Základní tok událostí</h1><p>Systém načte aktuální hodnotu parametru MostRecentLastModified. Do toho parametru systém uložil po skončení posledního úspěšného importu datum a čas z nejnovějšího záznamu (tj. takového záznamu ze zdrojových dat, který má nejnovější datum a čas změny).</p><ol><li>Systém vyhledá jednotlivé zdrojové záznamy, jejichž datum změny je novější než hodnota MostRecentLastModified. Pokud má parametr hodnotu NULL, pak systém vezme všechny zdrojové záznamy.</li><li>Pro každý záznam systém zkontroluje, že je validní - viz <a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-Validacevstupníchdat">Validace vstupních dat</a> (<a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-EF01:Nevalidnívstupnídata">EF01: Nevalidní vstupní data</a>).<br><ul><li>Viz <a href="../../../high-level-concept/integrace-78680671.html">Definice rozhraní</a> (list WinyX → RoadPlan) a <a href="#" data-page-title="Datový slovník">Datový slovník</a>.</li></ul></li><li>Pro každý záznam systém vyhodnotí typ operace, která má být s odpovídající instancí dané entity v systému RoadPlan provedena, a příslušnou operaci vykoná a zaloguje do transakčního logu.<br><ol><li>Buď založení nového záznamu - pokud záznam s příslušným externím Id dosud neexistuje,</li><li>nebo úpravu stávajícího záznamu,</li><li>nebo smazání záznamu (resp. označení záznamu jako smazaného). Pokud příslušný záznam v systému dosud neexistuje, pak jej systém v zájmu zachování referenční integrity nejdříve založí a pak označí za smazaný. </li></ol></li><li>Po úspěšném dokončení importu všech záznamů systém aktualizuje hodnotu parametru MostRecentLastModified = nejnovější datum a čas změny, který se vyskytl mezi záznamy úspěšně importovanými v této iteraci. </li></ol><p>Poznámky:</p><ul><li>Čas v DB rozhraní je v UTC.</li><li>Synchronizují sa jen záznamy, které mají poslední změnu v ohraničeném okně, <code>(poslední úspěšný import; čas začátku importu></code></li></ul><h1>Alternativní toky událostí</h1><h3>AF01: Aktualizace vozidla</h3><h4>Vstupní podmínky</h4><ul><li>Na rozhraní bylo dodáno <a href="../../../datove-modely/datovy-78681044.html">Vozidlo</a> s existujícím ID (došlo tedy k aktualizaci existujícího <a href="../../../datove-modely/datovy-78681044.html">Vozidla</a>).</li><li>U zmíněného vozidla došlo ke změně hodnoty atributu RZ.</li></ul><h4>Tok událostí</h4><ol><li>Systém najde všechny <a href="../../../datove-modely/datovy-78681044.html">Denní výkony</a> splňující všechny dále uvedené podmínky zároveň:<br><ol><li>Na <a href="../../../datove-modely/datovy-78681044.html">Denní výkon</a> je přiřazeno odpovídající <a href="../../../datove-modely/datovy-78681044.html">Vozidlo</a> (atribut Vozidlo).</li><li><a href="../../../datove-modely/datovy-78681044.html">Denní výkon</a> je v jednom z dále uvedených stavů (atribut Stav): Plánovaný, Schválený, Plněný, Vypůjčený.</li></ol></li><li>Pro všechny nalezené <a href="../../../datove-modely/datovy-78681044.html">Denní výkony</a>:<br><ol><li>Pokud jsou splněny všechny dále uvedené podmínky zároveň, je právě zkoumaný <a href="../../../datove-modely/datovy-78681044.html">Denní výkon</a> přeskočen: <strong>Skok na krok 2</strong>.<br><ul><li>Právě zkoumaný <a href="../../../datove-modely/datovy-78681044.html">Denní výkon</a> ve stavu Vypůjčený (atribut Stav).</li><li>Datum realizace právě zkoumaného <a href="../../../datove-modely/datovy-78681044.html">Denního výkonu</a> je v minulosti (atribut Datum realizace).</li></ul></li><li>Systém aktualizuje textovou identifikaci <a href="../../../datove-modely/datovy-78681044.html">Vozidla</a> právě zkoumaného <a href="../../../datove-modely/datovy-78681044.html">Denní výkonu</a> (atribut Textová identifikace vozidla) dle odpovídajícího <a href="../../../datove-modely/datovy-78681044.html">Vozidla</a> (atribut RZ).</li></ol></li></ol><h3>AF02: Odebrání druhu odpadu ve smlouvě</h3><p>Jedná se o dočasnou úpravu! Důvodem je „zvláštní“ chováním ve WinyX, kdy dochází k neopodstatněné deaktivaci vazeb s druhy odpadu ve smlouvě. S přechodem na Helios bude chování odebráno.</p><h4>Vstupní podmínky</h4><ul><li>Na rozhraní byl dodán <a href="../../../datove-modely/datovy-78681044.html">Druh odpadu ve smlouvě</a>, u kterého má být provedeno odebrání (byl získán neaktivní <a href="../../../datove-modely/datovy-78681044.html">Druh odpadu ve smlouvě</a>).</li></ul><h4>Tok událostí</h4><ol><li>Systém vyhodnotí, zda na rozhraní existuje alespoň jeden <a href="../../../datove-modely/datovy-78681044.html">Druh odpadu ve smlouvě</a> (na rozhraní se jedná o entitu BCED_CustomerContractWasteType, tomu odpovídají i dále zmiňované názvy atributů), který splňuje všechny dále uvedené podmínky zároveň:<br><ul><li>Jedná se o aktivní záznam – atribut Status nabývá hodnoty 1.</li><li>Hodnota atributu <strong>CustomerContractId</strong> odpovídá hodnotě stejného atributu u právě zkoumanému záznamu.</li><li>Hodnota atributu <strong>OrganizationalUnitId</strong> odpovídá hodnotě stejného atributu u právě zkoumanému záznamu.</li><li>Hodnota atributu <strong>WasteTypeId</strong> odpovídá hodnotě stejného atributu u právě zkoumanému záznamu.</li><li>Nejedná se o právě zkoumaný záznam (vzhledem k tomu, že hledáme pouze aktivní záznamy, by neměla být podmínka nikdy splněna).</li></ul></li><li>Pokud na rozhraní existuje alespoň jeden odpovídající aktivní <a href="../../../datove-modely/datovy-78681044.html">Druh odpadu ve smlouvě</a>:<br><ol><li>Systém přeskočí synchronizací právě zkoumaného záznamu (nedochází k jeho odebrání).</li></ol></li></ol><p>Stručný popis: Pokud v rámci synchronizace získáme NEAKTIVNÍ záznam s druhem odpadu ve smlouvě, systém vyhodnotí, zda na integračním rozhraní neexistuje také odpovídající AKTIVNÍ záznam. Systém tedy zjistí, zda na integračním rozhraní existuje alespoň jeden aktivní záznam se stejným ID rámcové smlouvy (včetně ID provozovny) a ID druhu odpadu. Pokud existuje, NENÍ záznam v RoadPlan označen jako neaktivní. V opačném případě JE záznam v RoadPlan označen jako neaktivní.</p><h1>Výjimkové toky událostí</h1><h3>EF01: Nevalidní vstupní data</h3><ol><li>Systém zaloguje informaci o chybě do business logu.</li><li>Systém ukončí UC.</li></ol><p>Poznámka: V případě výskytu chybných dat tedy import neproběhne a čeká na opravu dat.</p><h3>EF02: Nedostupné databázové rozhraní</h3><ol><li>Systém zaloguje informaci o nedostupnosti rozhraní do business logu.</li><li>Systém ukončí UC.</li></ol><h1>Výstupní podmínky</h1><p>Je provedena synchronizace dat - s jednotlivými instancemi dané entity byly vykonány příslušné operace.</p><h1>Validace</h1><h3>Validace vstupních dat</h3><ul><li>Všechny povinné položky jsou vyplněny.</li><li>Není porušena referenční integrita (chybějící nebo nevalidní záznamy, na které odkazují cizí klíče).</li><li>Vyplněné položky jsou správného datového typu, v povoleném rozsahu.</li><li>Datum vytvoření / modifikace záznamu nesmí ležet v budoucnosti.</li></ul><h1>Algoritmy</h1><h3>Mapování Typ nádoby : Druh dopravy</h3><p>Tabulka ContainerType neobsahuje sloupec s uvedením Druhu dopravy. V rámci importu bude k jednotlivým Typům nádob doplněn Druh dopravy následovně:</p><table><tbody><tr><th>Typ nádoby</th><th colspan="1">Druh dopravy</th><th colspan="1">Poznámka</th></tr><tr><td><p>Ekosklad</p><p>Mobilný lisovací kontajner</p><p>Prípojný kontajner</p><p>Stacionárna lis. jednotka</p><p>HNK</p></td><td colspan="1">Hákový nakladač</td><td colspan="1">–</td></tr><tr><td>VOK</td><td colspan="1">Ramenový nakladač</td><td colspan="1">–</td></tr><tr><td colspan="1">MGB</td><td colspan="1">Lisovací vozidlo</td><td colspan="1">–</td></tr><tr><td colspan="1">malé nádoby</td><td colspan="1">Komunální vozidlo – pilot</td><td colspan="1">–</td></tr><tr><td colspan="1">–</td><td colspan="1">Cisterna</td><td colspan="1">V rámci původní synchronizační komponenty není řešen.</td></tr></tbody></table><h3>Mapování Provozovna : Organizační složka FLWW</h3><p>Provozovny jsou do RoadPlan importovány z FleetwareWebAPI (entita Organizační složka). V databázovém rozhraní rovněž figuruje entita Provozovna.</p><p>Odpovídající vazba mezi WinyX Provozovnou a Fleetware Organizační složkou vznikne vyplněním hodnoty Externí Identifikátor ve Fleetware (hodnota = WinyX Id).</p><p>Ve WinyX i ve Fleetware figuruje víceúrovňová hierarchická struktura Provozoven:</p><ul><li>Na nejvyšší úrovni jsou tzv. Společnosti (kořen stromu), pod ně náleží Provozovny, které se mohou případně dále dělit na další organizační celky.</li><li>Tuto hierarchii je zapotřebí při importu zachovat, podle <a href="../../../datove-modely/datovy-78681044.html">Datového slovníku </a>entita <a href="../../../datove-modely/datovy-78681044.html">Provozovna</a> obsahuje vazbu na nadřízenou Provozovnu a atribut Úroveň, který definuje vzdálenost ke kořenu (nadřazené Společnosti).</li></ul><p> Mapování mezi atributy Provozovny a FleetwareWebAPI</p><table><tbody><tr><th>Provozovna</div></th><th colspan="1">API endpoint</div></th><th>API atribut</div></th><th>poznámky</div></th></tr><tr><td>Kód</td><td colspan="1"><pre>/organizatinalUnits</pre></td><td>code</td><td> </td></tr><tr><td colspan="1">Název</td><td colspan="1"><pre>/organizatinalUnits</pre></td><td colspan="1">name</td><td colspan="1"> </td></tr><tr><td colspan="1">Nadřazená provozovna</td><td colspan="1"><pre>/organizatinalUnits</pre></td><td colspan="1">parentId*</td><td colspan="1">S využitím daného atributu reference nastavena na příslušnou instanci Provozovna.</td></tr><tr><td colspan="1">Úroveň</td><td colspan="1"><pre>/organizatinalUnits</pre></td><td colspan="1"><p>parentId*</p><p>(type*)</p></td><td colspan="1"><p>Platí, že organizationalUnit, která má "parentId": null, má hloubku = 0. Taková organizationaUnit bude mít zároveň "type": "C".</p><p>Úroveň ostatních organizationalUnit je zapotřebí v rámci importu spočítat na základě referencí parentId.</p></td></tr><tr><td colspan="1">Adresa</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Stav gekódingu</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Změna adresy</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Provozní doba od</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Provozní doba do</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Kontakt na dispečink</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Souřadnice</td><td colspan="1">–</td><td colspan="1">–</td><td colspan="1">Atribut je nastaven v rámci <a href="#" data-page-title="500UC38: Upravit provozovnu">500UC38: Upravit provozovnu</a>.</td></tr><tr><td colspan="1">Externí identifikátor</td><td colspan="1"><pre>/organizatinalUnits</pre></td><td colspan="1">externalId*</td><td colspan="1">Obsahuje WinyXId příslušné Provozovny.</td></tr></tbody></table><h3>Vygenerování názvu místa realizace</h3><p>Tabulka CustomerSite neobsahuje název místa realizace. </p><p>Ten bude v rámci importu vygenerován automaticky v následujícím tvaru: <strong><Address.City>, <strong><Address.Street> (</strong><strong><Customer.Name>)</strong></strong>. Na příslušné záznamy Customer, Address odkazují cizí klíče záznamu CustomerSite.</p><ul><li>příklady názvů: "Bratislava, Gorkého (ACME s.r.o.)"; "Trenčín (Fiktivní, a.s.)" - případ s nevyplněnou ulicí</li></ul><p>(Tvar názvu je analogický s <a href="../../uzivatelske-rozhrani/500uixx-sprava-dat/500ui04-82837662.html">chováním při založení Místa realizace</a>).</p><h3>Vygenerování příznaku výchozího záznamu</h3><p>WinyX nezná příznak výchozího záznamu pro tyto entity:</p><ul><li>Osoba zákazníka: výchozí statutární zástupce.</li><li>Osoba zákazníka: výchozí kontaktní osoba.</li><li>Místo realizace: výchozí Místo realizace.</li></ul><p>Ve všech těchto případech bude v rámci importu vygenerovaný příznak výchozího záznamu takto:</p><ul><li>Výchozí záznam bude odpovídat záznamu s nejnižším ExternalId.</li></ul><p>Při každém zápisu nového a zneplatnění existujícího záznamu je zapotřebí zaručit existenci právě jednoho výchozího záznamu.</p><p><br></p><p>Uživatelské rozhraní</p><p>UC není vizuální.</p><h1>Revize</h1><h3>1. 3. 2023: Tomáš Nadrchal</h3><table><tbody><tr><th>Odkaz</div></div></div></div></div></div></div></th><th>Stručný popis změny/doplnění</div></div></div></div></div></div></div></th></tr><tr><td colspan="1"><a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-Mapov%C3%A1n%C3%ADTypn%C3%A1doby:Druhdopravy">Mapování Typ nádoby : Druh dopravy</a></td><td colspan="1">Doplněna podpora pro nové typy dopravy (naznačeno modře).</td></tr></tbody></table><h3>27. 7. 2022: Tomáš Nadrchal</h3><table><tbody><tr><th>Odkaz</div></div></div></div></div></div></div></th><th>Stručný popis změny/doplnění</div></div></div></div></div></div></div></th></tr><tr><td colspan="1"><a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-AF02:Odebr%C3%A1n%C3%ADdruhuodpaduvesmlouv%C4%9B">AF02: Odebrání druhu odpadu ve smlouvě</a></td><td colspan="1"><p>Doplněn alternativní tok pro synchronizaci druhů odpadu ve smlouvě (naznačeno modře).</p><p>RADIUMPOP-1758</p></td></tr></tbody></table><h3>8. 10. 2019: Miroslav Slivoně</h3><table><tbody><tr><th>Odkaz</div></div></div></div></div></div></div></th><th>Stručný popis změny/doplnění</div></div></div></div></div></div></div></th></tr><tr><td colspan="1"><a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-AF01:Aktualizacevozidla">AF01: Aktualizace vozidla</a>  </td><td colspan="1">Doplněn alternativní tok pro případ, kdy dojde k aktualizaci <a href="../../../datove-modely/datovy-78681044.html">Vozidla</a>.</td></tr></tbody></table><h3>20. 6. 2019: Miroslav Slivoně</h3><table><tbody><tr><th>Odkaz</div></div></div></div></div></div></div></th><th>Stručný popis změny/doplnění</div></div></div></div></div></div></div></th></tr><tr><td colspan="1"><a href="https://confluence.radium.cz/display/mpgskdispecer/600UC01%3A+Import+dat+z+WinyX#id-600UC01:ImportdatzWinyX-Mapov%C3%A1n%C3%ADProvozovna:Organiza%C4%8Dn%C3%ADslo%C5%BEkaFLWW">Mapování Provozovna : Organizační složka FLWW</a></td><td colspan="1"><p>Doplněna mapovací tabulka atributů, zapracován nový atribut Provozovna.Úroveň.</p></td></tr></tbody></table>
</div>
</body>
</html>

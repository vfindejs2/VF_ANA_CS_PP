<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>WinyX / Helios Sync Service</title>
</head>
<body>
<div class="wiki-content">
<p></p><p>Dokument popisuje základné technické aspekty synchronizácie dát do Roadplan z externého systému WinyX a popisuje činnosť tzv. <strong>winyx-sync-service</strong>, ktorá predstavuje komponent Roadplan  systému určený na túto synchronizáciu.</p><ul><li> z pohľadu Roadplan  systému je interakcia so systémom WinyX len na úrovni databázy - teda systém Roadpaln číta (prípadne zapisuje) dáta z databázy Winyx DB (SQL Server)<br><ul><li>zápis sa nerobí do tabuliek ktoré používa systém WinyX ale len do tabuliek vytvorených pre účely systému Roadplan</li></ul></li></ul><p> </p><p> </p><p></p><h2>Koncept synchronizácie entít z WinyX DB do systému Roadplan</h2><h3>Určenie dotknutých entít v rámci synchronizačného cyklu</h3><p>Prepojenie medzi entitou systému Winyx a entitou v Roadplan bude na základe spoločného atribútu.</p><ul><li>z pohľadu systému Roadplan ide o atribút: <strong>external_id</strong></li><li>z pohľadu externého systému WinyX ide o atribút: <strong>external_id</strong><br><ul><li>tento atribút nie je natívne súčasťou Winyx DB ale je vytvorený nutnými úpravami (vytvorením nových tabuliek) vo Winyx DB pri nasadení systému</li><li>hodnota je vyskladaná na základe atribútov entity ktoré predstavujú primárny klúč danej entity</li><li>pattern ako je tento atribút vyskladaný v prípade dvoch atribútov ktoré sú ako primárny kľúč: <strong>{{ attribute_1 }}::{{ attribute_2 }}</strong><br><ul><li>medzi dvomi hodnotami atribútov sú dve dvojbodky</li><li>ak je ich atribútov viac, medzi každým sú dve dvojbodky</li></ul></li></ul></li></ul><p> </p><p>Pre každú synchronizovanú entitu je vytvorená nová tabuľka a databázový view - ako tieto tabuľky a view pre jednotlivé entity vytvoriť je v rámci kapitoly "Nasadenie služby" popísané nižšie.</p><ul><li>pre každú sync. entity bude vytvorená externá tabuľka s názvom <strong>[<entity_name>_synced_at]</strong>, ktorá bude obsahovať atribúty <strong>synced_at </strong>a<strong> sync_failed_at</strong><ul><li><strong>účel tabuľky je vytvárať záznamy o tom, kedy konkrétna entita bola synchronizovaná alebo synchronizovaná s chybou</strong><ul><li>v tabuľke je vždy atribút <strong>external_id </strong>a atribúty ktoré sú ako PRIMARY_KEY zo zdrojovej tabuľky</li></ul></li><li>atribút synced_at bude obsahovať timestamp (čas) čítania dát enity v rámci synchronizačného cyklu zapísany až <strong>po úspešnej synchronizácii</strong> entity</li><li>atribút sync_failed_at bude obsahovať najstarší čas (čítania dát) zlyhania synchronizácie a bude nullovaný až po úspešnom synchronizovaní entity</li><li>synced_at a sync_failed_at zapisuje priamo WinyX synchrnonizačná služba do WinyX DB</li></ul></li><li>vytvorený DB view s názvom <strong>[<entity_name>_synced]</strong><ul><li><strong>účel view je prepojiť zdrojovú tabuľku, "synced_at" tabuľku aby sme spojili tieto dáta a na základe toho mohli určovať ktoré entity sa majú synchronizovať</strong><ul><li>rozhoduje sa na základe atríbutov: <strong>synced_at, sync_failed_at </strong>a<strong> LastModified</strong></li><li>view obsahuje všetky atribúty zo zdrojovej tabuľky</li><li>niektoré view môžu zo zdrojovej tabuľky vybrať záznamy len na základe nejakého pravidla - to je popísané v rámci detailnej analýzy</li></ul></li></ul></li></ul><h3>WinyX / Helios DB určená pre viacero Roadplan nasadení</h3><p>WinyX DB môže v niektorých prípadoch slúžiť pre viacero nasadení. Koncept fungovanie winyx-sync-service na tento účel vyžaduje vo WinyX / Helios DB vytvoriť tabuľku <strong>sync_deploy_envs</strong>, ktorá ukladá jednotlivé názvy prostredí ktoré sa na Winyx / Helios DB pripíjajú (definujeme na úrovni .env parametrov pre winyx-sync-service).</p><p>Záznam do tejto tabuľky vznikne pri spustení winyx-sync-service (v prípade ak už existuje, nestane sa nič). </p><p>Záznamy v tejto tabuľke zabezpečia duplikátne vytvorenie záznom entít v databázových view, pričom každý záznam bude mať na sebe informáciu pre aké prostredie nasadenia patrí. Táto informácie je ukladaná aj na tabuľke <strong>[<entity_name>_synced_at]</strong></p><h3>Entity, závislosti a validácie</h3><p>Odkazy ma detailnú analýzu synchronizácie:</p><ul><li><a href="https://confluence.radium.cz/pages/viewpage.action?pageId=93592913">synchronizované entity, ich závislosti a dáta</a></li><li>validácie na základe <a href="https://confluence.radium.cz/pages/viewpage.action?pageId=88033012">https://confluence.radium.cz/pages/viewpage.action?pageId=88033012</a></li></ul><h3>Proces synchronizácie</h3><p>Služba spúšťa v definovanom intervale (viď v rámci sekcii "Konfigurácia") job, tzv. synchronizačný cyklus, v rámci ktorého sa synchronizujú jednotlivé entity v definovanom poradí (vzhľadom nato že medzi nimi existujú závislosti).</p><p>Synchronizácia entít prebieha synchrónne - to znamená, že sa musí dokončiť synchronizácia entity (napr. adresa) a následne sa až spustí synchronizácia ďalšej entity (napr. zákazník).</p><p>Synchronizačný cyklus je možné prostredníctvom API (viď sekcia "Manažment") vypnúť alebo zapnúť a takisto je možné cez API získať info o tom či synchronizácia práve beží alebo nie.</p><h2>Konfigurácia</h2><p>Konfigurovateľné parametre budú obsahovať (definujú sa na úrovni .env parametrov pre winyx-sync-service):</p><ul><li>interval synchronizácie v podobe CRON stringu alebo číselná hodnota v minútach  (<strong>SYNC_DEFAULT_INTERVAL</strong>)</li><li>flag podmieňujúci spustenie intervalovej synchronizácie (<strong>SYNC_DEFAULT_ENABLED</strong>)<br><ul><li>default: false</li><li>cez API (popísané nižšie) vieme manuálne spustiť/zastaviť intervalovú synchronizáciu</li></ul></li><li>definovanie počtu entít v dávke ktoré sa budú synchronizovať voči sync-service (<strong>SYNC_MAX_BATCH_SIZE</strong>)<br><ul><li>default: 200</li></ul></li><li>definovanie id tenanta pre ktorého budú dáta synchronizované do roadplan (<strong>SYNC_TENANT_ID</strong>)</li></ul><h3>Interval synchronizácie</h3><ul><li>každá 15. minúta</li><li>časový interval bude definovaný pri nasadení a jeho hodnotu bude možné meniť pomocou API</li><li>synchronizácia sa nespustí, pokiaľ (predošlý) synchronizačný cyklus stále prebieha, alebo je synchronizácia vypnutá <em>(<strong>SYNC_DEFAULT_ENABLED</strong><strong>=false</strong>)</em></li></ul><h2>Manažment</h2><p>Počas behu služby bude možné meniť niektoré konfiguračné parametre služby, prípadne získavať info o stave synchronizácie prostredníctvom REST API</p><ul><li>popis API s jednotlivými endpointami tu: <a href="#" data-page-title="API - Winyx Sync Service">API - Winyx Sync Service</a></li></ul><h2>Logovanie</h2><ul><li>v rámci synchronizácie sa logujú nasledovné eventy:<ul><li>spustenie a ukončenie synchronizačného cyklu<ul><li>Sync started</li><li>Sync finished </li></ul></li><li>spustenie a ukončenie synchronizácie konkrétnej entity</li></ul></li><li>všetky logy služby sú zberiané na úrovni dockeru prostredníctvom fluentbit a je možné ich prezerať v Kibane pre dané nasadenie</li></ul><h3>Vyfiltrovanie logov pre winyx-sync-service</h3><p>Info logy v Kibane filtrovať na základe parametra "<strong>COMPONENT_NAME</strong>" s hodnotou "<strong>winyx-sync-service</strong>"</p><ul><li>filter definovat ako:<br><ul><li>Field: <strong>COMPONENT_NAME</strong></li><li>Operator: <strong>is</strong></li><li>values: <strong>winyx-sync-service</strong> </li></ul></li></ul><p>Priklad vysledku:</p><p><img src="winyx-helios-sync-service-122198093_images/image2021-6-28_11-15-40.png"></p><p> </p><h3>Spustenie a ukončenie synchronizácie konkrétnej entity</h3><p>Nazvy v logovacej sprave (stlpec "msg" v Kibana) pre entity je podla tabulky  a stlpec "entityName v Roadplan "</p><p>Filtrovanie konkretnej synchronizacie entity:</p><ul><li>na stlpec "msg" je mozne dat filter  ako napr: <ul><li>Field: <strong>msg</strong></li><li>Operator: <strong>is one of</strong></li><li>values: nazov "<strong>entityName v Roadplan</strong>" podla odkazu vyssie</li></ul></li><li>priklad pre entitu: <strong>order</strong></li></ul><p><img src="winyx-helios-sync-service-122198093_images/image2021-6-28_11-23-46.png"></p><ul><li>Vysledky filtra:</li></ul><p><img src="winyx-helios-sync-service-122198093_images/image2021-6-28_11-24-27.png"></p>
</div>
</body>
</html>
